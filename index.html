<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si Clauses + Commands</title>
    
    <style>
        :root {
            /* Paleta Azul Est√°ndar */
            --primary-blue: #007bff;
            --dark-blue: #0056b3;
            --green: #28a745;
            --red: #dc3545;
            --yellow: #f0ad4e;
            
            --bg-color: #f0f4f8;
            --container-bg: #ffffff;
            --text-color: #333;
            --header-bg: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            --tab-bg: #f1f1f1;
            --tab-active-bg: var(--primary-blue);
            --tab-text: #555;
            --tab-active-text: #ffffff;
            --border-color: #dee2e6;
            --light-gray-bg: #f8f9fa;
        }

        /* Modo Oscuro */
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #1e1e1e;
            --tab-bg: #333;
            --tab-active-bg: var(--primary-blue);
            --tab-text: #bbb;
            --tab-active-text: #ffffff;
            --border-color: #444;
            --light-gray-bg: #2a2a2a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 950px;
            margin: 0 auto;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.07);
            overflow: hidden;
            transition: background-color 0.3s;
        }
        header {
            background: var(--header-bg);
            color: white;
            padding: 20px 35px;
            text-align: center;
            position: relative;
        }
        header h1 { margin: 0; font-size: 2.5em; }
        header p { font-size: 1.2em; opacity: 0.9; margin: 5px 0 0; }
        
        .header-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }
        .control-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
        }
        .control-button:hover { background: rgba(255,255,255,0.4); }

        /* Pesta√±as Scrollable */
        .main-tab-nav {
            display: flex;
            background-color: var(--tab-bg);
            border-bottom: 3px solid var(--dark-blue);
            overflow-x: auto;
        }
        .main-tab-nav button {
            background-color: inherit; border: none; outline: none; cursor: pointer;
            padding: 18px 20px; transition: 0.3s; font-size: 1.1em;
            font-weight: bold; color: var(--tab-text); flex-grow: 1; white-space: nowrap;
        }
        .main-tab-nav button:hover { background-color: var(--border-color); }
        .main-tab-nav button.active { background-color: var(--tab-active-bg); color: var(--tab-active-text); }
        
        .main-tab-content { display: none; padding: 30px; }
        .main-tab-content.is-active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Estilos Generales */
        h2 { color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); padding-bottom: 5px; font-size: 1.8em; margin-top: 0; }
        h3 { color: var(--green); font-size: 1.4em; margin-top: 25px; }
        .accent { color: var(--primary-blue); font-weight: bold; }
        
        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .tense-box { background-color: var(--light-gray-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; }
        
        .icon-wrapper { font-size: 4em; margin-bottom: 10px; display:block; }
        
        /* Video */
        .video-placeholder {
            background: var(--light-gray-bg); border: 2px dashed var(--border-color);
            border-radius: 8px; padding: 20px; text-align: center; margin-top: 20px;
        }
        .video-container {
            position: relative; width: 100%; padding-bottom: 56.25%; height: 0;
            overflow: hidden; border-radius: 8px; background: #000; margin-top: 20px; border: 1px solid var(--border-color);
        }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        /* Visualizador */
        .formula-visualizer {
            background-color: var(--light-gray-bg); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 20px; text-align: center; margin-top: 20px;
        }
        .formula-row { display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;}
        .formula-card {
            padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1.2em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer;
        }
        .fc-condition { background: #e8f5e9; color: #2e7d32; border: 2px solid #2e7d32; }
        .fc-arrow { font-size: 1.5em; color: #555; }
        .fc-command { background: #e3f2fd; color: #1565c0; border: 2px solid #1565c0; }

        /* Command Bank Styles */
        .bank-controls { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; background: var(--light-gray-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .bank-controls select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; min-width: 200px; background: var(--container-bg); color: var(--text-color); }
        
        .verb-card { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .verb-card:hover { transform: translateY(-3px); border-color: var(--primary-blue); }
        .verb-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }
        .verb-title { font-size: 1.3em; font-weight: bold; color: var(--primary-blue); text-transform: capitalize; }
        .verb-tag { background: var(--light-gray-bg); color: #666; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; border: 1px solid var(--border-color); }
        
        .cmd-person { color: #888; width: 40%; font-size: 0.9em; }
        .cmd-form { font-weight: bold; color: var(--text-color); cursor: pointer; transition: color 0.2s; }
        .cmd-form:hover { color: var(--primary-blue); }
        .cmd-form.neg { color: var(--red); }
        
        .tts-icon { cursor: pointer; margin-left: 5px; opacity: 0.6; font-size: 1em; transition: transform 0.2s, opacity 0.2s; }
        .tts-icon:hover { opacity: 1; transform: scale(1.2); }

        .btn-explain { background: var(--yellow); color: #333; border: none; padding: 3px 10px; border-radius: 15px; font-size: 0.8em; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .btn-explain:hover { background: #e0a800; }

        /* EXPLANATION MODAL */
        #explain-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--container-bg); padding: 30px; border-radius: 15px;
            max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative;
            border: 2px solid var(--primary-blue);
            color: var(--text-color);
        }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 1.5em; cursor: pointer; color: #666; }
        .explain-block { margin-bottom: 20px; border-left: 4px solid var(--border-color); padding-left: 15px; }
        .explain-block h4 { margin: 0 0 5px 0; color: var(--primary-blue); }
        .explain-label { font-weight: bold; color: #666; font-size: 0.9em; }
        .explain-ex { font-style: italic; background: var(--light-gray-bg); padding: 5px; border-radius: 4px; display: inline-block; margin-top: 5px; }

        /* Tablas */
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.95em; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: left; }
        th { background-color: var(--light-gray-bg); }

        /* Pr√°ctica */
        .quiz-section { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed var(--border-color); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .refresh-btn { font-size: 0.9em; padding: 5px 10px; background-color: var(--primary-blue); color: white; border:none; border-radius: 4px; cursor: pointer;}

        .quiz-question { margin-bottom: 15px; background: var(--light-gray-bg); padding: 15px; border-radius: 5px; }
        .quiz-question button { background-color: var(--container-bg); border: 1px solid var(--primary-blue); color: var(--primary-blue); padding: 8px 15px; margin-right: 10px; border-radius: 5px; cursor: pointer; margin-top: 5px; }
        .quiz-question button:hover { background-color: var(--primary-blue); color: white; }
        
        .feedback { font-weight: bold; margin-left: 10px; }
        .correct { color: var(--green); } .incorrect { color: var(--red); }
        .explanation-text { font-size: 0.9em; color: #555; margin-top: 10px; padding: 8px; background: #e9ecef; border-radius: 4px; }
        .explanatory-note { font-size: 0.9em; font-style: italic; background: var(--light-gray-bg); padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px dashed var(--border-color);}

        /* Historia */
        .interactive-story { background: #fffbe6; border: 1px solid #ffe58f; padding: 20px; border-radius: 8px; font-size: 1.1em; line-height: 2; }
        .interactive-story select { padding: 2px 5px; border: 1px solid #ccc; border-radius: 4px; }
        body.dark-mode .interactive-story { background: #2c2c20; border-color: #444; color: #eee; }

        /* Drag Drop */
        .sorter-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .dropzone { min-height: 200px; background: var(--light-gray-bg); border: 3px dashed var(--border-color); border-radius: 8px; padding: 10px; }
        .dropzone h4 { text-align: center; margin-top: 0; color: var(--dark-blue); }
        .draggable { background-color: var(--container-bg); border: 1px solid #ccc; padding: 10px; margin-bottom: 8px; border-radius: 5px; cursor: grab; display: inline-block; margin-right: 5px; }
        .draggable.dragging { opacity: 0.5; border: 2px dashed var(--primary-blue); }
        #items-to-sort { margin-top: 20px; padding: 10px; background: var(--tab-bg); border-radius: 8px; min-height: 60px; }

        /* Flashcards - CORREGIDO (Horizontal) */
        .flashcard-app { display: flex; flex-direction: column; align-items: center; }
        .flashcard-container { width: 90%; max-width: 500px; height: 300px; perspective: 1000px; margin-bottom: 20px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 10px; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        
        .card-face { 
            position: absolute; width: 100%; height: 100%; 
            backface-visibility: hidden; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            text-align: center; 
            padding: 20px; 
            border-radius: 10px; 
            box-sizing: border-box; 
            /* TEXTO NORMAL (NO VERTICAL) */
            font-size: 1.4em;
            line-height: 1.4;
            white-space: normal;
            overflow: hidden;
        }
        
        .card-front { background: var(--container-bg); border: 2px solid var(--primary-blue); color: var(--text-color); }
        .card-back { background: var(--light-gray-bg); border: 2px solid var(--green); color: var(--dark-blue); transform: rotateY(180deg); }
        .card-back p { margin: 15px 0 0; font-size: 0.8em; color: var(--text-color); opacity: 0.8; }
        body.dark-mode .card-back { color: var(--text-color); }
        
        .flashcard-nav { display: flex; justify-content: center; gap: 20px; }
        .flashcard-nav button { font-size: 1em; font-weight: bold; }

        /* Command Formation Box */
        .command-formation-box {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        body.dark-mode .command-formation-box { background: #102a44; border-color: #0d47a1; }
        .command-example { font-size: 1.2em; margin: 10px 0; }
        .cmd-highlight { color: #d32f2f; font-weight: bold; text-decoration: underline; }

    </style>
</head>
<body class="">

    <div class="container">
        <header>
            <div class="header-controls">
                <button class="control-button" onclick="toggleLang()" id="btn-lang">EN / ES</button>
                <button class="control-button" onclick="toggleTheme()">‚òÄÔ∏è/üåô</button>
            </div>
            <h1 data-lang-key="header_title">Si Clauses + Commands</h1>
            <p data-lang-key="header_subtitle">Giving Advice & Instructions</p>
        </header>
        
        <nav class="main-tab-nav">
            <button class="main-tab-link active" onclick="changeMainTab(event, 'tab-metaphor')" data-lang-key="tab_1">üö¶ The Concept</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-formacion')" data-lang-key="tab_2">‚úçÔ∏è The Formula</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-bank')" data-lang-key="tab_bank">üìö Command Bank</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-practica')" data-lang-key="tab_3">üß† Interactive Practice</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-flashcards')" data-lang-key="tab_4">üìá Flashcards</button>
        </nav>

        <main>
            <div id="tab-metaphor" class="main-tab-content is-active">
                <h2 data-lang-key="metaphor_title">Condition & Reaction</h2>
                
                <div class="comparison-grid">
                    <div class="tense-box">
                        <span class="icon-wrapper">ü§î</span>
                        <h3 style="color: var(--green);" data-lang-key="cond_title">The Condition (Si...)</h3>
                        <p data-lang-key="metaphor_cond">If a specific situation happens...</p>
                        <p><em>"Si <strong>tienes</strong> fr√≠o..."</em></p>
                    </div>
                    <div class="tense-box">
                        <span class="icon-wrapper">üëâ</span>
                        <h3 style="color: var(--primary-blue);" data-lang-key="cmd_title">The Command (¬°Hazlo!)</h3>
                        <p data-lang-key="metaphor_cmd">...do this action immediately.</p>
                        <p><em>"¬°<strong>Ponte</strong> un abrigo!"</em></p>
                    </div>
                </div>

                <h3 style="margin-top: 30px;" data-lang-key="video_title">Video Tutorial</h3>
                <div class="video-container">
                    <iframe src="https://drive.google.com/file/d/1voQ1bwByvhucuyRyR5sUbfHmFhZO5XZ0/preview" allow="autoplay"></iframe>
                </div>

                <h3 style="margin-top: 30px;" data-lang-key="viz_title">Interactive Formula</h3>
                <div class="formula-visualizer">
                    <p data-lang-key="viz_desc">Click the condition to see the command.</p>
                    <div class="formula-row">
                        <div class="formula-card fc-condition" onclick="toggleViz()">Si (t√∫) <strong>vas</strong> a la fiesta...</div>
                        <div class="fc-arrow">‚û°Ô∏è</div>
                        <div class="formula-card fc-command" id="viz-result">???</div>
                    </div>
                </div>
            </div>

            <div id="tab-formacion" class="main-tab-content">
                <h2 data-lang-key="form_title">The Structure</h2>
                
                <div class="command-formation-box">
                    <h3 data-lang-key="form_rule_title">How to Form Regular Commands (T√∫)</h3>
                    <p data-lang-key="form_rule_desc">It's easy! Use the <strong>3rd Person Singular (√âl/Ella)</strong> form of the Present Tense.</p>
                    <div class="comparison-grid">
                        <div class="tense-box" onclick="speak('Habla')">
                            <h4 data-lang-key="ar_verbs">-AR Verbs</h4>
                            <p>Hablar &rarr; √âl <strong>habla</strong></p>
                            <p class="command-example">¬°<span class="cmd-highlight">Habla</span> m√°s alto!</p>
                        </div>
                        <div class="tense-box" onclick="speak('Come')">
                            <h4 data-lang-key="er_ir_verbs">-ER / -IR Verbs</h4>
                            <p>Comer &rarr; Ella <strong>come</strong></p>
                            <p class="command-example">¬°<span class="cmd-highlight">Come</span> tu comida!</p>
                        </div>
                    </div>
                </div>

                <h3>Key Irregular Commands (T√∫)</h3>
                <p>Memorize these short forms (Vin Diesel has ten weapons):</p>
                <table>
                    <tr><th>Infinitive</th><th>Command (T√∫)</th></tr>
                    <tr onclick="speak('Ven')"><td>Venir</td><td><strong>Ven</strong></td></tr>
                    <tr onclick="speak('Di')"><td>Decir</td><td><strong>Di</strong></td></tr>
                    <tr onclick="speak('Sal')"><td>Salir</td><td><strong>Sal</strong></td></tr>
                    <tr onclick="speak('Haz')"><td>Hacer</td><td><strong>Haz</strong></td></tr>
                    <tr onclick="speak('Ten')"><td>Tener</td><td><strong>Ten</strong></td></tr>
                    <tr onclick="speak('Ve')"><td>Ir</td><td><strong>Ve</strong></td></tr>
                    <tr onclick="speak('Pon')"><td>Poner</td><td><strong>Pon</strong></td></tr>
                    <tr onclick="speak('S√©')"><td>Ser</td><td><strong>S√©</strong></td></tr>
                </table>
            </div>

            <div id="tab-bank" class="main-tab-content">
                <h2 data-lang-key="bank_title">Command Bank</h2>
                <p data-lang-key="bank_desc">Reference for regular and irregular commands.</p>
                
                <div class="bank-controls">
                    <label>Filter:</label>
                    <select id="cmdVerbSelect">
                        <option value="all">All Verbs</option>
                        </select>
                </div>

                <div id="cmdBankContainer">
                    </div>
            </div>

            <div id="explain-modal">
                <div class="modal-content">
                    <span class="modal-close" onclick="closeModal()">&times;</span>
                    <h2 id="modal-title">Verb Title</h2>
                    <p id="modal-trans" style="font-style:italic; color:#666; margin-bottom:20px;">To do something</p>
                    
                    <div class="explain-block" style="border-left: 4px solid var(--green); padding-left:10px; margin-bottom:15px;">
                        <h4>‚úÖ Affirmative Command (T√∫)</h4>
                        <p class="explain-label">Form: <span id="modal-aff-form" style="color:black; font-size:1.2em; font-weight:bold;">-</span></p>
                        <p class="explain-label">Translation: <span id="modal-aff-trans" style="font-weight:normal;">-</span></p>
                        <span class="explain-ex" id="modal-aff-ex">-</span>
                    </div>
                    
                    <div class="explain-block" style="border-left: 4px solid var(--red); padding-left:10px;">
                        <h4>‚ùå Negative Command (T√∫)</h4>
                        <p class="explain-label">Form: <span id="modal-neg-form" style="color:black; font-size:1.2em; font-weight:bold;">-</span></p>
                        <p class="explain-label">Translation: <span id="modal-neg-trans" style="font-weight:normal;">-</span></p>
                        <span class="explain-ex" id="modal-neg-ex">-</span>
                    </div>

                    <div style="margin-top:20px; padding:10px; background:#e3f2fd; border-radius:5px; font-size:0.9em; color:#333;">
                        <strong>Usage:</strong> This is used to give informal orders to one person.
                    </div>
                </div>
            </div>

            <div id="tab-practica" class="main-tab-content">
                <h2 data-lang-key="practice_main_title">Interactive Practice</h2>
                
                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="quiz_title">Part 1: Quick Quiz</h3>
                        <button id="generate-quiz" class="refresh-btn button-secondary" data-lang-key="btn_new">New Quiz</button>
                    </div>
                    <div class="explanatory-note" data-lang-key="quiz_note">Note: Audio reads infinitives to avoid spoilers.</div>
                    <div id="quiz-container"></div>
                </div>

                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="story_title">Part 2: Advice Story</h3>
                        <button id="generate-story" class="refresh-btn button-secondary" data-lang-key="btn_new_story">New Story</button>
                    </div>
                    <div id="story-container" class="interactive-story"></div>
                    <button id="check-story-btn" class="button-primary" style="margin-top: 20px;" data-lang-key="btn_check">Check Story</button>
                </div>

                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="drag_title">Part 3: Logic Matcher</h3>
                        <button id="generate-drag" class="refresh-btn button-secondary" data-lang-key="btn_new_match">New Matcher</button>
                    </div>
                    <p data-lang-key="drag_desc">Match the <strong>Condition</strong> (Green) with the logical <strong>Command</strong> (Blue).</p>
                    <div id="items-to-sort">
                        <div id="drag-items-pool"></div>
                    </div>
                    <div class="sorter-container">
                        <div class="dropzone" id="zone-condition"><h4 style="color: var(--green);">If... (Condition)</h4></div>
                        <div class="dropzone" id="zone-command"><h4 style="color: var(--primary-blue);">Then... (Command)</h4></div>
                    </div>
                    <button id="check-drag-btn" class="button-primary" style="margin-top: 20px;" data-lang-key="btn_check_match">Check Matches</button>
                    <div id="drag-feedback" class="feedback"></div>
                </div>
            </div>

            <div id="tab-flashcards" class="main-tab-content">
                <h2>Flashcards</h2>
                <div class="flashcard-app">
                    <div class="flashcard-container">
                        <div class="flashcard" id="flashcard">
                            <div class="card-face card-front" id="card-front"></div>
                            <div class="card-face card-back" id="card-back"></div>
                        </div>
                    </div>
                    <div class="flashcard-nav">
                        <button onclick="prevCard()" class="button-secondary" data-lang-key="btn_prev">Previous</button>
                        <button onclick="flipCard()" class="button-primary" data-lang-key="btn_flip">Flip</button>
                        <button onclick="nextCard()" class="button-secondary" data-lang-key="btn_next">Next</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

<script>

// --- DATA & TRANSLATIONS ---
const uiData = {
    en: {
        header_title: "Si Clauses + Commands",
        header_subtitle: "Giving Advice & Instructions",
        tab_1: "üö¶ The Concept",
        tab_2: "‚úçÔ∏è The Formula",
        tab_bank: "üìö Command Bank",
        tab_3: "üß† Interactive Practice",
        tab_4: "üìá Flashcards",
        metaphor_title: "Condition & Reaction",
        cond_title: "The Condition (Si...)",
        metaphor_cond: "If a specific situation happens...",
        cmd_title: "The Command (Do it!)",
        metaphor_cmd: "...do this action immediately.",
        video_title: "Video Tutorial",
        viz_title: "Interactive Formula",
        viz_desc: "Click the condition to see the command.",
        form_title: "The Structure",
        form_rule_title: "How to Form Regular Commands (T√∫)",
        form_rule_desc: "It's easy! Use the <strong>3rd Person Singular (√âl/Ella)</strong> form of the Present Tense.",
        ar_verbs: "-AR Verbs",
        er_ir_verbs: "-ER / -IR Verbs",
        bank_title: "Command Bank",
        bank_desc: "Reference for regular and irregular commands.",
        practice_main_title: "Interactive Practice",
        quiz_title: "Part 1: Quick Quiz",
        btn_new: "New Quiz",
        quiz_note: "Note: Audio reads infinitives to avoid spoilers.",
        story_title: "Part 2: Advice Story",
        btn_new_story: "New Story",
        btn_check: "Check Story",
        drag_title: "Part 3: Logic Matcher",
        btn_new_match: "New Matcher",
        drag_desc: "Match the Condition (Green) with the logical Command (Blue).",
        btn_check_match: "Check Matches",
        btn_prev: "Previous",
        btn_flip: "Flip",
        btn_next: "Next"
    },
    es: {
        header_title: "Si + Mandatos",
        header_subtitle: "Dar Consejos e Instrucciones",
        tab_1: "üö¶ El Concepto",
        tab_2: "‚úçÔ∏è La F√≥rmula",
        tab_bank: "üìö Banco de Mandatos",
        tab_3: "üß† Pr√°ctica Interactiva",
        tab_4: "üìá Flashcards",
        metaphor_title: "Condici√≥n y Reacci√≥n",
        cond_title: "La Condici√≥n (Si...)",
        metaphor_cond: "Si ocurre una situaci√≥n...",
        cmd_title: "El Mandato (¬°Hazlo!)",
        metaphor_cmd: "...haz esta acci√≥n inmediatamente.",
        video_title: "Video Tutorial",
        viz_title: "F√≥rmula Interactiva",
        viz_desc: "Haz clic en la condici√≥n para ver el mandato.",
        form_title: "La Estructura",
        form_rule_title: "C√≥mo Formar Mandatos Regulares (T√∫)",
        form_rule_desc: "¬°Es f√°cil! Usa la forma de <strong>3¬™ Persona Singular (√âl/Ella)</strong> del Presente.",
        ar_verbs: "Verbos -AR",
        er_ir_verbs: "Verbos -ER / -IR",
        bank_title: "Banco de Mandatos",
        bank_desc: "Referencia de mandatos regulares e irregulares.",
        practice_main_title: "Pr√°ctica Interactiva",
        quiz_title: "Part 1: Quiz R√°pido",
        btn_new: "Nuevo Quiz",
        quiz_note: "Nota: El audio lee infinitivos para no revelar la respuesta.",
        story_title: "Part 2: Historia de Consejos",
        btn_new_story: "Nueva Historia",
        btn_check: "Verificar Historia",
        drag_title: "Part 3: Parejas L√≥gicas",
        btn_new_match: "Nuevo Juego",
        drag_desc: "Une la Condici√≥n (Verde) con el Mandato l√≥gico (Azul).",
        btn_check_match: "Verificar Parejas",
        btn_prev: "Anterior",
        btn_flip: "Voltear",
        btn_next: "Siguiente"
    }
};

let currentLang = 'en';

// --- COMMAND DATABASE (With orthographic changes included for automatic negative commands) ---
const commandDatabase = [
    { verb: "hablar", tag: "Regular -AR", auto: true, trans: "To speak", ex_aff: "¬°Habla m√°s alto!", ex_neg: "¬°No hables en clase!", trans_aff: "Speak louder!", trans_neg: "Don't speak in class!" },
    { verb: "comer", tag: "Regular -ER", auto: true, trans: "To eat", ex_aff: "¬°Come tus verduras!", ex_neg: "¬°No comas eso!", trans_aff: "Eat your vegetables!", trans_neg: "Don't eat that!" },
    { verb: "vivir", tag: "Regular -IR", auto: true, trans: "To live", ex_aff: "¬°Vive la vida!", ex_neg: "¬°No vivas con miedo!", trans_aff: "Live life!", trans_neg: "Don't live in fear!" },
    { verb: "escuchar", tag: "Regular -AR", auto: true, trans: "To listen", ex_aff: "¬°Escucha al profesor!", ex_neg: "¬°No escuches m√∫sica ahora!", trans_aff: "Listen to the teacher!", trans_neg: "Don't listen to music now!" },
    // Irregulars
    { verb: "venir", tag: "Irregular", auto: false, forms: ["ven", "no vengas", "venga", "vengan", "vengamos"], trans: "To come", ex_aff: "¬°Ven aqu√≠!", ex_neg: "¬°No vengas tarde!", trans_aff: "Come here!", trans_neg: "Don't come late!" },
    { verb: "decir", tag: "Irregular", auto: false, forms: ["di", "no digas", "diga", "digan", "digamos"], trans: "To say/tell", ex_aff: "¬°Di la verdad!", ex_neg: "¬°No digas mentiras!", trans_aff: "Tell the truth!", trans_neg: "Don't tell lies!" },
    { verb: "salir", tag: "Irregular", auto: false, forms: ["sal", "no salgas", "salga", "salgan", "salgamos"], trans: "To leave/go out", ex_aff: "¬°Sal de ah√≠!", ex_neg: "¬°No salgas sin chaqueta!", trans_aff: "Get out of there!", trans_neg: "Don't go out without a jacket!" },
    { verb: "hacer", tag: "Irregular", auto: false, forms: ["haz", "no hagas", "haga", "hagan", "hagamos"], trans: "To do/make", ex_aff: "¬°Haz tu tarea!", ex_neg: "¬°No hagas ruido!", trans_aff: "Do your homework!", trans_neg: "Don't make noise!" },
    { verb: "tener", tag: "Irregular", auto: false, forms: ["ten", "no tengas", "tenga", "tengan", "tengamos"], trans: "To have", ex_aff: "¬°Ten paciencia!", ex_neg: "¬°No tengas miedo!", trans_aff: "Have patience!", trans_neg: "Don't be afraid!" },
    { verb: "ir", tag: "Irregular", auto: false, forms: ["ve", "no vayas", "vaya", "vayan", "vayamos"], trans: "To go", ex_aff: "¬°Ve a la escuela!", ex_neg: "¬°No vayas solo!", trans_aff: "Go to school!", trans_neg: "Don't go alone!" },
    { verb: "poner", tag: "Irregular", auto: false, forms: ["pon", "no pongas", "ponga", "pongamos"], trans: "To put", ex_aff: "¬°Pon la mesa!", ex_neg: "¬°No pongas los pies ah√≠!", trans_aff: "Set the table!", trans_neg: "Don't put your feet there!" },
    { verb: "ser", tag: "Irregular", auto: false, forms: ["s√©", "no seas", "sea", "sean", "seamos"], trans: "To be", ex_aff: "¬°S√© amable!", ex_neg: "¬°No seas grosero!", trans_aff: "Be kind!", trans_neg: "Don't be rude!" },
    // Orthographic
    { verb: "tocar", tag: "Orthographic (-car)", auto: false, forms: ["toca", "no toques", "toque", "toquen", "toquemos"], trans: "To touch", ex_aff: "¬°Toca la puerta!", ex_neg: "¬°No toques eso!", trans_aff: "Touch the door!", trans_neg: "Don't touch that!" },
    { verb: "llegar", tag: "Orthographic (-gar)", auto: false, forms: ["llega", "no llegues", "llegue", "lleguen", "lleguemos"], trans: "To arrive", ex_aff: "¬°Llega temprano!", ex_neg: "¬°No llegues tarde!", trans_aff: "Arrive early!", trans_neg: "Don't arrive late!" },
    { verb: "empezar", tag: "Orthographic (-zar)", auto: false, forms: ["empieza", "no empieces", "empiece", "empiecen", "empecemos"], trans: "To start", ex_aff: "¬°Empieza ahora!", ex_neg: "¬°No empieces la pel√≠cula!", trans_aff: "Start now!", trans_neg: "Don't start the movie!" },
    { verb: "empacar", tag: "Orthographic (-car)", auto: false, forms: ["empaca", "no empaques", "empaque", "empaquen", "empaquemos"], trans: "To pack", ex_aff: "¬°Empaca tu maleta!", ex_neg: "¬°No empaques todo eso!", trans_aff: "Pack your suitcase!", trans_neg: "Don't pack all that!" }
];

// 20 Flashcards
const flashcardData = [
    { en: "If you have time, call me.", es: "Si <strong>tienes</strong> tiempo, <strong>ll√°mame</strong>.", explanation: "Si + Present -> Command" },
    { en: "If you go to the store, buy milk.", es: "Si <strong>vas</strong> a la tienda, <strong>compra</strong> leche.", explanation: "Ir (vas) -> Comprar (compra)" },
    { en: "If you are tired, sleep.", es: "Si <strong>est√°s</strong> cansado, <strong>duerme</strong>.", explanation: "Estar (est√°s) -> Dormir (duerme)" },
    { en: "If you see Juan, tell him hi.", es: "Si <strong>ves</strong> a Juan, <strong>dile</strong> hola.", explanation: "Ver (ves) -> Decir (di - irregular)" },
    { en: "If you want to pass, study.", es: "Si <strong>quieres</strong> aprobar, <strong>estudia</strong>.", explanation: "Querer (quieres) -> Estudiar (estudia)" },
    { en: "If it rains, take an umbrella.", es: "Si <strong>llueve</strong>, <strong>lleva</strong> un paraguas.", explanation: "Llover (llueve) -> Llevar (lleva)" },
    { en: "If you are cold, put on a coat.", es: "Si <strong>tienes</strong> fr√≠o, <strong>ponte</strong> un abrigo.", explanation: "Tener (tienes) -> Ponerse (ponte - irregular)" },
    { en: "If you leave, close the door.", es: "Si <strong>sales</strong>, <strong>cierra</strong> la puerta.", explanation: "Salir (sales) -> Cerrar (cierra)" },
    { en: "If you are hungry, eat something.", es: "Si <strong>tienes</strong> hambre, <strong>come</strong> algo.", explanation: "Tener (tienes) -> Comer (come)" },
    { en: "If you don't understand, ask.", es: "Si no <strong>entiendes</strong>, <strong>pregunta</strong>.", explanation: "Entender (entiendes) -> Preguntar (pregunta)" },
    { en: "If you have a problem, tell me.", es: "Si <strong>tienes</strong> un problema, <strong>d√≠melo</strong>.", explanation: "Decir (di) + me + lo" },
    { en: "If you come early, help me.", es: "Si <strong>vienes</strong> temprano, <strong>ay√∫dame</strong>.", explanation: "Venir (vienes) -> Ayudar (ayuda)" },
    { en: "If you are sad, listen to music.", es: "Si <strong>est√°s</strong> triste, <strong>escucha</strong> m√∫sica.", explanation: "Estar (est√°s) -> Escuchar (escucha)" },
    { en: "If you make a mistake, fix it.", es: "Si <strong>haces</strong> un error, <strong>arr√©glalo</strong>.", explanation: "Hacer (haces) -> Arreglar (arregla)" },
    { en: "If you go out, be careful.", es: "Si <strong>sales</strong>, <strong>ten</strong> cuidado.", explanation: "Tener (ten - irregular)" },
    { en: "If you drive, don't drink.", es: "Si <strong>conduces</strong>, no <strong>bebas</strong>.", explanation: "Negative Command (Subjunctive form)" },
    { en: "If you visit Paris, go to the Louvre.", es: "Si <strong>visitas</strong> Par√≠s, <strong>ve</strong> al Louvre.", explanation: "Ir (ve - irregular)" },
    { en: "If you cook, clean the kitchen.", es: "Si <strong>cocinas</strong>, <strong>limpia</strong> la cocina.", explanation: "Cocinar -> Limpiar" },
    { en: "If you are bored, read a book.", es: "Si <strong>est√°s</strong> aburrido, <strong>lee</strong> un libro.", explanation: "Estar -> Leer" },
    { en: "If you love her, tell her.", es: "Si la <strong>amas</strong>, <strong>d√≠selo</strong>.", explanation: "Decir (di) + se + lo" }
];

// 25 Quiz Questions
const quizBank = [
    { q: "Si (tener) tiempo, (llamar) a Mar√≠a.", options: ["tienes / llama", "tengas / llames"], correct: 0, explanation: "Si + Present Ind. -> Command." },
    { q: "Si (ir) al mercado, (comprar) pan.", options: ["vas / compra", "vayas / compres"], correct: 0, explanation: "Ir (vas) -> Comprar (compra)." },
    { q: "Si (ver) a Luis, (decir) la verdad.", options: ["veas / di", "ves / dile"], correct: 1, explanation: "Ver (ves) -> Decir (di + le)." },
    { q: "Si no (entender), (preguntar).", options: ["entiendes / pregunta", "entiendas / preguntes"], correct: 0, explanation: "Entender (e-ie) -> Preguntar." },
    { q: "Si (estar) cansado, (descansar).", options: ["est√°s / descansa", "est√©s / descansas"], correct: 0, explanation: "Estar (est√°s) -> Descansar." },
    { q: "Si (hacer) sol, (ponerse) crema.", options: ["hace / ponte", "haga / ponga"], correct: 0, explanation: "Hacer (hace) -> Ponerse (pon + te)." },
    { q: "Si (querer) venir, (venir).", options: ["quieres / ven", "quieras / vengas"], correct: 0, explanation: "Querer (quieres) -> Venir (ven - irreg)." },
    { q: "Si (salir), (cerrar) la puerta.", options: ["sales / cierra", "salgas / cierres"], correct: 0, explanation: "Salir (sales) -> Cerrar (cierra)." },
    { q: "Si (tener) hambre, (comer).", options: ["tienes / come", "tengas / comas"], correct: 0, explanation: "Tener -> Comer." },
    { q: "Si (ser) valiente, (hacerlo).", options: ["eres / hazlo", "seas / hazlo"], correct: 0, explanation: "Ser (eres) -> Hacer (haz + lo)." },
    { q: "Si te (doler) la cabeza, (tomar) esto.", options: ["duele / toma", "duela / tomes"], correct: 0, explanation: "Doler (duele) -> Tomar." },
    { q: "Si (buscar) paz, (meditar).", options: ["buscas / medita", "busques / medites"], correct: 0, explanation: "Buscar -> Meditar." },
    { q: "Si (necesitar) ayuda, (pedir).", options: ["necesitas / pide", "necesites / pidas"], correct: 0, explanation: "Pedir (pide)." },
    { q: "Si (sentirse) mal, (ir) al m√©dico.", options: ["te sientes / ve", "te sientas / vaya"], correct: 0, explanation: "Ir (ve - irreg)." },
    { q: "Si (romper) algo, (pagar).", options: ["rompes / paga", "rompas / pagues"], correct: 0, explanation: "Romper -> Pagar." },
    { q: "Si (escuchar) m√∫sica, (bailar).", options: ["escuchas / baila", "escuches / bailes"], correct: 0, explanation: "Escuchar -> Bailar." },
    { q: "Si (llegar) tarde, no (entrar).", options: ["llegas / entres", "llegues / entra"], correct: 0, explanation: "Negative command uses subjunctive form (no entres)." },
    { q: "Si (poder), (ayudarme).", options: ["puedes / ay√∫dame", "puedas / ayuda"], correct: 0, explanation: "Poder -> Ayudar." },
    { q: "Si (leer) esto, (compartir).", options: ["lees / comparte", "leas / compartas"], correct: 0, explanation: "Leer -> Compartir." },
    { id: "q20", q: "Si (viajar), (disfrutar).", options: ["viajas / disfruta", "viajes / disfrutes"], correct: 0, explanation: "Viajar -> Disfrutar." },
    { id: "q21", q: "Si (perder), no (llorar).", options: ["pierdes / llores", "pierdas / llora"], correct: 0, explanation: "Negative Command (no llores)." },
    { id: "q22", q: "Si (beber), no (conducir).", options: ["bebes / conduzcas", "bebas / conduces"], correct: 0, explanation: "Neg command (no conduzcas)." },
    { id: "q23", q: "Si (ver) el error, (corregir).", options: ["ves / corrige", "veas / corrigas"], correct: 0, explanation: "Ver -> Corregir." },
    { id: "q24", q: "Si (hacer) fr√≠o, (abrigarse).", options: ["hace / abr√≠gate", "haga / abrigarte"], correct: 0, explanation: "Hacer -> Abrigarse (reflexive)." },
    { id: "q25", q: "Si (querer) paz, (perdonar).", options: ["quieres / perdona", "quieras / perdonas"], correct: 0, explanation: "Querer -> Perdonar." }
];

// 5 Stories
const storyBank = [
    {
        id: "story1",
        html: `
            <h3>Consejos de Salud üè•</h3>
            <span>Si t√∫</span> 
            <select id="s1-1" data-ans="quieres"><option value="w">quieras</option><option value="c">quieres</option></select>
            <span>estar sano,</span> 
            <select id="s1-2" data-ans="come"><option value="c">come</option><option value="w">comas</option></select>
            <span>bien. Si te</span> 
            <select id="s1-3" data-ans="sientes"><option value="c">sientes</option><option value="w">sientas</option></select>
            <span>cansado,</span> 
            <select id="s1-4" data-ans="duerme"><option value="w">duermas</option><option value="c">duerme</option></select>
            <span>ocho horas. Si no</span> 
            <select id="s1-5" data-ans="tienes"><option value="c">tienes</option><option value="w">tengas</option></select>
            <span>tiempo,</span> 
            <select id="s1-6" data-ans="haz"><option value="c">haz</option><option value="w">hagas</option></select>
            <span>ejercicio en casa.</span>
        `
    },
    {
        id: "story2",
        html: `
            <h3>Preparando un Viaje ‚úàÔ∏è</h3>
            <span>Si</span> 
            <select id="s2-1" data-ans="vas"><option value="c">vas</option><option value="w">vayas</option></select>
            <span>a Espa√±a,</span> 
            <select id="s2-2" data-ans="visita"><option value="w">visites</option><option value="c">visita</option></select>
            <span>Madrid. Si</span> 
            <select id="s2-3" data-ans="necesitas"><option value="c">necesitas</option><option value="w">necesites</option></select>
            <span>ayuda,</span> 
            <select id="s2-4" data-ans="pregunta"><option value="c">pregunta</option><option value="w">preguntes</option></select>
            <span>a la gente. Si</span> 
            <select id="s2-5" data-ans="tienes"><option value="c">tienes</option><option value="w">tengas</option></select>
            <span>hambre,</span> 
            <select id="s2-6" data-ans="prueba"><option value="c">prueba</option><option value="w">pruebes</option></select>
            <span>las tapas.</span>
        `
    },
    {
        id: "story3",
        html: `
            <h3>En la Cocina üç≥</h3>
            <span>Si</span> 
            <select id="s3-1" data-ans="cocinas"><option value="c">cocinas</option><option value="w">cocines</option></select>
            <span>pasta,</span> 
            <select id="s3-2" data-ans="hierve"><option value="w">hirvas</option><option value="c">hierve</option></select>
            <span>el agua primero. Si</span> 
            <select id="s3-3" data-ans="usas"><option value="c">usas</option><option value="w">uses</option></select>
            <span>cuchillos,</span> 
            <select id="s3-4" data-ans="ten"><option value="c">ten</option><option value="w">tengas</option></select>
            <span>cuidado. Si</span> 
            <select id="s3-5" data-ans="terminas"><option value="c">terminas</option><option value="w">termines</option></select>
            <span>de comer,</span> 
            <select id="s3-6" data-ans="lava"><option value="c">lava</option><option value="w">laves</option></select>
            <span>los platos.</span>
        `
    },
    {
        id: "story4",
        html: `
            <h3>En la Escuela üìö</h3>
            <span>Si no</span> 
            <select id="s4-1" data-ans="comprendes"><option value="c">comprendes</option><option value="w">comprendas</option></select>
            <span>la lecci√≥n,</span> 
            <select id="s4-2" data-ans="levanta"><option value="w">levantes</option><option value="c">levanta</option></select>
            <span>la mano. Si</span> 
            <select id="s4-3" data-ans="quieres"><option value="c">quieres</option><option value="w">quieras</option></select>
            <span>sacar buenas notas,</span> 
            <select id="s4-4" data-ans="estudia"><option value="c">estudia</option><option value="w">estudies</option></select>
            <span>todos los d√≠as. Si</span> 
            <select id="s4-5" data-ans="sales"><option value="c">sales</option><option value="w">salgas</option></select>
            <span>tarde,</span> 
            <select id="s4-6" data-ans="corre"><option value="c">corre</option><option value="w">corras</option></select>
            <span>al autob√∫s.</span>
        `
    },
    {
        id: "story5",
        html: `
            <h3>Seguridad Online üîí</h3>
            <span>Si</span> 
            <select id="s5-1" data-ans="usas"><option value="c">usas</option><option value="w">uses</option></select>
            <span>internet,</span> 
            <select id="s5-2" data-ans="protege"><option value="w">protejas</option><option value="c">protege</option></select>
            <span>tu contrase√±a. Si</span> 
            <select id="s5-3" data-ans="ves"><option value="c">ves</option><option value="w">veas</option></select>
            <span>algo raro, no</span> 
            <select id="s5-4" data-ans="hagas"><option value="c">hagas</option><option value="w">haz</option></select>
            <span>clic. Si</span> 
            <select id="s5-5" data-ans="recibes"><option value="c">recibes</option><option value="w">recibas</option></select>
            <span>spam,</span> 
            <select id="s5-6" data-ans="b√≥rralo"><option value="c">b√≥rralo</option><option value="w">b√≥rrelo</option></select>
            <span>inmediatamente.</span>
        `
    }
];

// 20 Drag Items (Logic: If... -> Then...)
const dragDropBank = [
    { text: "Si tienes fr√≠o...", type: "condition" }, { text: "¬°Ponte un abrigo!", type: "command" },
    { text: "Si est√°s cansado...", type: "condition" }, { text: "¬°Duerme un poco!", type: "command" },
    { text: "Si tienes hambre...", type: "condition" }, { text: "¬°Come una manzana!", type: "command" },
    { text: "Si te duele la cabeza...", type: "condition" }, { text: "¬°Toma una aspirina!", type: "command" },
    { text: "Si no entiendes...", type: "condition" }, { text: "¬°Pregunta al profesor!", type: "command" },
    { text: "Si vas a la playa...", type: "condition" }, { text: "¬°Usa protector solar!", type: "command" },
    { text: "Si quieres aprobar...", type: "condition" }, { text: "¬°Estudia m√°s!", type: "command" },
    { text: "Si ves un accidente...", type: "condition" }, { text: "¬°Llama a la polic√≠a!", type: "command" },
    { text: "Si llegas tarde...", type: "condition" }, { text: "¬°Corre!", type: "command" },
    { text: "Si est√°s aburrido...", type: "condition" }, { text: "¬°Lee un libro!", type: "command" },
    { text: "Si llueve...", type: "condition" }, { text: "¬°Lleva paraguas!", type: "command" },
    { text: "Si cocinas...", type: "condition" }, { text: "¬°Lava los platos!", type: "command" }
];

// --- LOGIC ---

document.addEventListener('DOMContentLoaded', () => {
    let currentStoryData = {};

    // 1. TABS
    window.changeMainTab = function(evt, tabId) {
        document.querySelectorAll('.main-tab-content').forEach(el => el.classList.remove('is-active'));
        document.querySelectorAll('.main-tab-link').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('is-active');
        evt.currentTarget.classList.add('active');
        
        if (tabId === 'tab-practica' && !document.getElementById('quiz-container').hasChildNodes()) {
            generateQuiz(); generateStory(); generateDragDrop();
        }
        if (tabId === 'tab-bank') { renderBank(); }
    }

    // 2. VISUALIZER
    window.toggleViz = function() {
        const res = document.getElementById('viz-result');
        res.textContent = "¬°¬°Ponte un abrigo!!";
        res.style.backgroundColor = "#fff9c4";
        speak("Ponte un abrigo");
        setTimeout(() => res.style.backgroundColor = "#e3f2fd", 500);
    }

    // 3. QUIZ
    document.getElementById('generate-quiz').addEventListener('click', generateQuiz);

    function generateQuiz() {
        const container = document.getElementById('quiz-container');
        container.innerHTML = '';
        const selectedQuestions = [...quizBank].sort(() => 0.5 - Math.random()).slice(0, 5);
        
        selectedQuestions.forEach((q, i) => {
            const qId = `q_${i}`;
            // Clean audio text
            const cleanQ = q.q.replace(/[()]/g, "").replace(/ /g, ', ');
            const tts = `<span class="tts-icon" onclick="speak('${cleanQ}')">üîä</span>`;
            
            let html = `<div class="quiz-question" id="${qId}">
                <p>${i+1}. ${q.q} ${tts}</p>`;
            
            q.options.forEach((opt, idx) => {
                html += `<button onclick="checkQuiz('${qId}', ${idx === q.correct})">${opt}</button>`;
            });
            
            html += `<span class="feedback"></span>
                     <div class="explanation-text" style="display:none;">${q.explanation}</div>
                     </div>`;
            container.innerHTML += html;
        });
    }

    window.checkQuiz = function(qId, isCorrect) {
        const el = document.getElementById(qId);
        const fb = el.querySelector('.feedback');
        const exp = el.querySelector('.explanation-text');
        exp.style.display = 'block';
        if(isCorrect) {
            fb.textContent = "Correct! üëç"; fb.className = "feedback correct";
        } else {
            fb.textContent = "Try again. üòï"; fb.className = "feedback incorrect";
        }
    }

    // 4. STORY
    document.getElementById('generate-story').addEventListener('click', generateStory);
    document.getElementById('check-story-btn').addEventListener('click', checkStory);

    function generateStory() {
        currentStoryData = storyBank[Math.floor(Math.random() * storyBank.length)];
        document.getElementById('story-container').innerHTML = currentStoryData.html;
        document.querySelectorAll('.story-explanation').forEach(e=>e.remove());
    }

    function checkStory() {
        const container = document.getElementById('story-container');
        
        const selects = container.querySelectorAll('select');
        selects.forEach(sel => {
            const val = sel.value;
            const isCorrect = val === 'c';
            
            sel.style.borderColor = isCorrect ? "var(--green)" : "var(--red)";
            sel.style.backgroundColor = isCorrect ? "#d4edda" : "#f8d7da";
        });
    }

    // 5. DRAG & DROP
    const dragPool = document.getElementById('drag-items-pool');
    document.getElementById('generate-drag').addEventListener('click', generateDragDrop);
    document.getElementById('check-drag-btn').addEventListener('click', checkDrag);
    
    let currentDragItems = [];

    function generateDragDrop() {
        dragPool.innerHTML = '';
        document.getElementById('drag-feedback').textContent = '';
        document.querySelectorAll('.dropzone .draggable').forEach(e => e.remove());
        document.querySelectorAll('.drag-explanation').forEach(e => e.remove());

        // Pick 6 random pairs (12 items total)
        const uniquePairs = new Map();
        while (uniquePairs.size < 6) { 
            const randomIndex = Math.floor(Math.random() * (dragDropBank.length / 2)) * 2;
            const condition = dragDropBank[randomIndex];
            const command = dragDropBank[randomIndex + 1];
            if (condition && command) {
                uniquePairs.set(condition.text, condition);
                uniquePairs.set(command.text, command);
            }
        }
        currentDragItems = Array.from(uniquePairs.values()).sort(() => 0.5 - Math.random());
        
        currentDragItems.forEach(item => {
            const el = document.createElement('div');
            el.className = 'draggable';
            el.draggable = true;
            const ttsHtml = `&nbsp;<span class="tts-icon" onclick="event.stopPropagation(); speak('${item.text.replace(/<[^>]*>?/gm, '')}')">üîä</span>`;
            el.innerHTML = `${item.text} ${ttsHtml}`;
            el.dataset.type = item.type;
            
            el.addEventListener('dragstart', e => e.target.classList.add('dragging'));
            el.addEventListener('dragend', e => e.target.classList.remove('dragging'));
            el.addEventListener('touchstart', touchStart, {passive: false});
            
            dragPool.appendChild(el);
        });
        
        setupDropzones();
    }

    function setupDropzones() {
        document.querySelectorAll('.dropzone').forEach(zone => {
            zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', e => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                const dragging = document.querySelector('.dragging');
                if(dragging) zone.appendChild(dragging);
            });
            zone.addEventListener('touchenter', () => zone.classList.add('drag-over'), false);
            zone.addEventListener('touchleave', () => zone.classList.remove('drag-over'), false);
        });
    }

    // Touch Logic
    let tDrag = null;
    function touchStart(e) {
        if(e.target.classList.contains('tts-icon')) return;
        let originalTarget = e.target.closest('.draggable');
        if(!originalTarget) return;
        
        // Prepare for dragging
        const rect = originalTarget.getBoundingClientRect();
        const clone = originalTarget.cloneNode(true);
        originalTarget.style.opacity = '0.0'; // Hide original
        
        clone.style.position = 'fixed';
        clone.style.zIndex = 1000;
        clone.style.width = rect.width + 'px';
        clone.style.height = rect.height + 'px';
        clone.style.left = rect.left + 'px';
        clone.style.top = rect.top + 'px';
        clone.classList.add('dragging');
        clone.id = 'touch-drag-clone';
        document.body.appendChild(clone);
        
        tDrag = { original: originalTarget, clone: clone };

        document.addEventListener('touchmove', touchMove, {passive: false});
        document.addEventListener('touchend', touchEnd);
    }
    
    function touchMove(e) {
        if(!tDrag || !tDrag.clone) return;
        e.preventDefault();
        const t = e.touches[0];
        tDrag.clone.style.left = (t.clientX - tDrag.clone.offsetWidth/2) + 'px';
        tDrag.clone.style.top = (t.clientY - tDrag.clone.offsetHeight/2) + 'px';
        
        // Highlight dropzones
        document.querySelectorAll('.dropzone').forEach(zone => zone.classList.remove('drag-over'));
        const elem = document.elementFromPoint(t.clientX, t.clientY);
        const zone = elem ? elem.closest('.dropzone') : null;
        if(zone) zone.classList.add('drag-over');
    }
    
    function touchEnd(e) {
        if(!tDrag) return;

        const t = e.changedTouches[0];
        const elem = document.elementFromPoint(t.clientX, t.clientY);
        const zone = elem ? elem.closest('.dropzone') : null;
        
        if(zone) {
            // Move original to new zone
            tDrag.original.style.opacity = '1';
            zone.appendChild(tDrag.original);
        } else {
            // Move original back to pool if not dropped in a zone
            tDrag.original.style.opacity = '1';
            dragPool.appendChild(tDrag.original);
        }

        // Cleanup clone
        tDrag.clone.remove();
        
        document.removeEventListener('touchmove', touchMove);
        document.removeEventListener('touchend', touchEnd);
        document.querySelectorAll('.dropzone').forEach(zone => zone.classList.remove('drag-over'));
        tDrag = null;
    }


    function checkDrag() {
        let correct = 0;
        let totalItems = 0;
        const zones = {
            'zone-condition': 'condition',
            'zone-command': 'command'
        };
        
        for (const [zoneId, type] of Object.entries(zones)) {
            const zone = document.getElementById(zoneId);
            zone.querySelectorAll('.draggable').forEach(item => {
                totalItems++;
                if(item.dataset.type === type) {
                    item.style.backgroundColor = '#d4edda'; correct++;
                } else {
                    item.style.backgroundColor = '#f8d7da';
                }
            });
        }
        document.getElementById('drag-feedback').textContent = `Correct: ${correct} out of ${totalItems}.`;
    }

    // 6. FLASHCARDS
    let cIdx = 0;
    function loadCard() {
        const d = flashcardData[cIdx];
        const tts = `&nbsp;<span class="tts-icon" onclick="speak('${d.es.replace(/<[^>]*>?/gm, '')}')">üîä</span>`;
        document.getElementById('card-front').innerHTML = d.en;
        document.getElementById('card-back').innerHTML = `${d.es} ${tts}<p>${d.explanation}</p>`;
        document.getElementById('flashcard').classList.remove('is-flipped');
    }
    window.flipCard = () => document.getElementById('flashcard').classList.toggle('is-flipped');
    window.nextCard = () => { cIdx = (cIdx+1)%flashcardData.length; loadCard(); };
    window.prevCard = () => { cIdx = (cIdx-1+flashcardData.length)%flashcardData.length; loadCard(); };
    
    document.getElementById('flashcard').addEventListener('click', function(e) {
        if(e.target.classList.contains('tts-icon')) {
            e.stopPropagation();
        } else {
            flipCard();
        }
    });

    // 7. COMMAND BANK GENERATOR
    function conjugateCmdRegular(verb) {
        const stem = verb.slice(0, -2);
        const end = verb.slice(-2);
        // Forms: T√∫(+), T√∫(-), Ud, Uds, Nos
        let tuNeg = "";
        
        if (end === "ar") {
            tuNeg = stem+"es";
        } else if (end === "er" || end === "ir") {
            tuNeg = stem+"as";
        }
        
        // Orthographic changes (just for regular conjugation logic)
        if (verb.endsWith("car")) { tuNeg = tuNeg.replace("ces", "ques"); } // -car
        if (verb.endsWith("gar")) { tuNeg = tuNeg.replace("ges", "gues"); } // -gar
        if (verb.endsWith("zar")) { tuNeg = tuNeg.replace("zas", "ces"); } // -zar (e.g. empezar -> empieces)

        if (end === "ar") return [stem+"a", "no "+tuNeg, stem+"e", stem+"en", stem+"emos"];
        if (end === "er") return [stem+"e", "no "+tuNeg, stem+"a", stem+"an", stem+"amos"];
        if (end === "ir") return [stem+"e", "no "+tuNeg, stem+"a", stem+"an", stem+"amos"]; 
        return ["-","-","-","-","-"];
    }
    
    // CORRECCI√ìN CLAVE: Funci√≥n showExplanation actualizada
    // Ahora recibe el √≠ndice del array y toma el objeto directamente.
    window.showExplanation = function(index) {
        const verbData = commandDatabase[index];
        if (!verbData) return;

        const modal = document.getElementById('explain-modal');
        
        // Traducciones espec√≠ficas
        const trans_aff = verbData.trans_aff || "Do it!";
        const trans_neg = verbData.trans_neg || "Don't do it!";
        const trans_infinitive = verbData.trans || "To do the action";

        // Ejemplos por defecto si no se proporcionan
        const affForm = verbData.forms[0] || '';
        const negForm = verbData.forms[1] || '';
        const ex_aff = verbData.ex_aff || `¬°${affForm.charAt(0).toUpperCase() + affForm.slice(1)} ahora!`;
        const ex_neg = verbData.ex_neg || `¬°${negForm.charAt(0).toUpperCase() + negForm.slice(1)} eso!`;

        document.getElementById('modal-title').textContent = verbData.verb.charAt(0).toUpperCase() + verbData.verb.slice(1);
        document.getElementById('modal-trans').textContent = trans_infinitive;
        
        document.getElementById('modal-aff-form').textContent = verbData.forms[0];
        document.getElementById('modal-aff-trans').textContent = trans_aff; // Traducci√≥n Correcta
        document.getElementById('modal-aff-ex').innerHTML = `Ex: "${ex_aff}" <span class="tts-icon" onclick="speak('${ex_aff}')">üîä</span>`;
        
        document.getElementById('modal-neg-form').textContent = verbData.forms[1];
        document.getElementById('modal-neg-trans').textContent = trans_neg; // Traducci√≥n Correcta
        document.getElementById('modal-neg-ex').innerHTML = `Ex: "${ex_neg}" <span class="tts-icon" onclick="speak('${ex_neg}')">üîä</span>`;
        
        modal.style.display = 'flex';
    }

    window.closeModal = function() {
        document.getElementById('explain-modal').style.display = 'none';
    }

    function renderBank() {
        const container = document.getElementById('cmdBankContainer');
        const select = document.getElementById('cmdVerbSelect');
        if(container.innerHTML.trim() !== "") return; // Already rendered

        commandDatabase.forEach((item, index) => {
            const opt = document.createElement('option');
            opt.value = item.verb; opt.textContent = item.verb;
            select.appendChild(opt);
            
            // Normalize Forms
            if(item.auto) item.forms = conjugateCmdRegular(item.verb);
            
            // Modificaci√≥n CRUCIAL: Usamos el √≠ndice para llamar a showExplanation
            const card = `
            <div class="verb-card" data-verb="${item.verb}">
                <div class="verb-header">
                    <span class="verb-title">${item.verb}</span>
                    <div>
                        <span class="verb-tag">${item.tag}</span>
                        <button class="btn-explain" onclick="showExplanation(${index})">üí° Explain</button>
                    </div>
                </div>
                <table>
                    <tr onclick="speak('${item.forms[0]}')"><td class="cmd-person">T√∫ (Afirm)</td><td class="cmd-form">${item.forms[0]} üîä</td></tr>
                    <tr onclick="speak('${item.forms[1]}')"><td class="cmd-person">T√∫ (Neg)</td><td class="cmd-form neg">${item.forms[1]} üîä</td></tr>
                    <tr onclick="speak('${item.forms[2]}')"><td class="cmd-person">Usted</td><td class="cmd-form">${item.forms[2]} üîä</td></tr>
                    <tr onclick="speak('${item.forms[3]}')"><td class="cmd-person">Ustedes</td><td class="cmd-form">${item.forms[3]} üîä</td></tr>
                    <tr onclick="speak('${item.forms[4]}')"><td class="cmd-person">Nosotros</td><td class="cmd-form">${item.forms[4]} üîä</td></tr>
                </table>
            </div>`;
            container.innerHTML += card;
        });

        select.addEventListener('change', (e) => {
            const val = e.target.value;
            document.querySelectorAll('.verb-card').forEach(c => {
                c.style.display = (val === 'all' || c.dataset.verb === val) ? '' : 'none';
            });
        });
    }

    // Utils
    window.toggleLang = function() {
        currentLang = currentLang === 'en' ? 'es' : 'en';
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            if(uiData[currentLang][key]) el.innerHTML = uiData[currentLang][key];
        });
    }

    window.toggleTheme = () => document.body.classList.toggle('dark-mode');

    // AUDIO ENGINE (Global)
    window.speak = function(txt) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'es-ES';
        
        const voices = window.speechSynthesis.getVoices();
        const v = voices.find(voice => voice.name.includes('Google') && voice.lang.includes('es')) || 
                  voices.find(voice => (voice.name.includes('Monica') || voice.name.includes('Paulina')) && voice.lang.includes('es')) ||
                  voices.find(voice => voice.lang.includes('es'));
        if(v) u.voice = v;
        
        window.speechSynthesis.speak(u);
    }
    
    // Global TTS listener to catch clicks on icons
    document.body.addEventListener('click', function(e) {
        if(e.target.classList.contains('tts-icon') && !e.target.closest('#flashcard')) {
            // Logic handled by inline onclick, but here for completeness
        }
    });

    // Init
    loadCard();
    window.speechSynthesis.onvoiceschanged = () => {}; 
});
</script>
</body>
</html>
