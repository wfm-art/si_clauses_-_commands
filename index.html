<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Impersonal Expressions</title>
    
    <style>
        :root {
            /* Paleta Azul Est√°ndar */
            --primary-blue: #007bff;
            --dark-blue: #0056b3;
            --green: #28a745;
            --red: #dc3545;
            --yellow: #f0ad4e;
            
            --bg-color: #f0f4f8;
            --container-bg: #ffffff;
            --text-color: #333;
            --header-bg: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            --tab-bg: #f1f1f1;
            --tab-active-bg: var(--primary-blue);
            --tab-text: #555;
            --tab-active-text: #ffffff;
            --border-color: #dee2e6;
            --light-gray-bg: #f8f9fa;
        }

        /* Modo Oscuro */
        body.dark-mode {
            --bg-color: #121212; --container-bg: #1e1e1e; --text-color: #e0e0e0;
            --header-bg: #1e1e1e; --tab-bg: #333; --tab-active-bg: var(--primary-blue);
            --tab-text: #bbb; --tab-active-text: #ffffff; --border-color: #444; --light-gray-bg: #2a2a20;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; transition: 0.3s; overscroll-behavior: none; }
        .container { max-width: 950px; margin: 0 auto; background: var(--container-bg); border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.07); overflow: hidden; }
        header { background: var(--header-bg); color: white; padding: 20px 35px; text-align: center; position: relative; }
        header h1 { margin: 0; font-size: 2.5em; }
        header p { font-size: 1.2em; opacity: 0.9; margin: 5px 0 0; }
        .header-controls { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; }
        .control-button { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.7); color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        /* Tabs */
        .main-tab-nav { display: flex; background: var(--tab-bg); border-bottom: 3px solid var(--dark-blue); overflow-x: auto; }
        .main-tab-nav button { background: inherit; border: none; padding: 18px 20px; cursor: pointer; font-size: 1.1em; font-weight: bold; color: var(--tab-text); flex-grow: 1; white-space: nowrap; }
        .main-tab-nav button.active { background: var(--tab-active-bg); color: var(--tab-active-text); }
        .main-tab-content { display: none; padding: 30px; }
        .main-tab-content.is-active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Visuals */
        h2 { color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); padding-bottom: 5px; margin-top: 0; }
        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .tense-box { background: var(--light-gray-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; }
        .icon-wrapper { font-size: 4em; display: block; margin-bottom: 10px; }
        
        /* Video */
        .video-placeholder { background: var(--light-gray-bg); border: 2px dashed var(--border-color); border-radius: 8px; padding: 20px; text-align: center; margin-top: 20px; }
        .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; background: #000; margin-top: 20px; border: 1px solid var(--border-color); }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        /* Visualizer */
        .formula-visualizer { background: var(--light-gray-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; margin-top: 20px; }
        .formula-controls { margin-bottom: 20px; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; margin: 0 10px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background: var(--primary-blue); }
        input:checked + .slider:before { transform: translateX(26px); }
        .formula-display { font-size: 1.3em; font-weight: bold; }
        .formula-part { padding: 8px 12px; border-radius: 5px; background: var(--container-bg); border: 1px solid var(--border-color); margin: 0 5px; display: inline-block; }
        .formula-part.subjunctive { background: #fff0f0; color: var(--red); border-color: var(--red); }
        .formula-part.infinitive { background: #f0fff0; color: var(--green); border-color: var(--green); }

        /* Bank Styles */
        .bank-controls { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; background: var(--light-gray-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .bank-controls select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; min-width: 200px; background: var(--container-bg); color: var(--text-color); }
        .verb-card { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; cursor: pointer; }
        .verb-card:hover { transform: translateY(-3px); border-color: var(--primary-blue); }
        .verb-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }
        .verb-title { font-size: 1.3em; font-weight: bold; color: var(--primary-blue); text-transform: capitalize; }
        .verb-tag { background: var(--light-gray-bg); color: #666; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; border: 1px solid var(--border-color); }
        .cmd-person { color: #888; width: 40%; font-size: 0.9em; }
        .cmd-form { font-weight: bold; color: var(--text-color); cursor: pointer; }
        .btn-explain { background: var(--yellow); color: #333; border: none; padding: 3px 10px; border-radius: 15px; font-size: 0.8em; cursor: pointer; font-weight: bold; margin-left: 10px; }
        
        /* Modal */
        #explain-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--container-bg); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--primary-blue); color: var(--text-color); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-close { position: absolute; top: 10px; right: 20px; font-size: 2.5em; font-weight: bold; cursor: pointer; color: #666; line-height: 0.8; }
        .modal-close:hover { color: var(--red); }
        .explain-block { margin-bottom: 20px; border-left: 4px solid var(--border-color); padding-left: 15px; }
        .explain-block h4 { margin: 0 0 5px 0; color: var(--primary-blue); }
        .explain-ex { font-style: italic; background: var(--light-gray-bg); padding: 5px; border-radius: 4px; display: inline-block; margin-top: 5px; }

        /* Practice */
        .quiz-section { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed var(--border-color); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .refresh-btn { font-size: 0.9em; padding: 5px 10px; background: var(--primary-blue); color: white; border:none; border-radius: 4px; cursor: pointer; }
        .quiz-question { background: var(--light-gray-bg); padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid var(--primary-blue); }
        .quiz-question button { background: var(--container-bg); border: 1px solid var(--primary-blue); color: var(--primary-blue); padding: 8px 15px; margin-right: 10px; border-radius: 5px; cursor: pointer; margin-top: 5px; }
        .quiz-question button:hover { background: var(--primary-blue); color: white; }
        .feedback { font-weight: bold; margin-left: 10px; }
        .correct { color: var(--green); } .incorrect { color: var(--red); }
        .explanation-text { font-size: 0.9em; color: #555; margin-top: 10px; padding: 8px; background: #e9ecef; border-radius: 4px; }
        .explanatory-note { font-size: 0.9em; font-style: italic; background: var(--light-gray-bg); padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px dashed var(--border-color);}

        /* Story */
        .interactive-story { background: #fffbe6; border: 1px solid #ffe58f; padding: 20px; border-radius: 8px; font-size: 1.1em; line-height: 2; }
        .interactive-story select { padding: 2px 5px; border: 1px solid #ccc; border-radius: 4px; }
        body.dark-mode .interactive-story { background: #2c2c20; border-color: #444; color: #eee; }
        
        /* Drag Drop - iPad Optimized */
        .sorter-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .dropzone { min-height: 200px; background: var(--light-gray-bg); border: 3px dashed var(--border-color); border-radius: 8px; padding: 10px; position: relative;}
        .dropzone h4 { text-align: center; margin-top: 0; color: var(--dark-blue); pointer-events: none; }
        .draggable { background: var(--container-bg); border: 1px solid #ccc; padding: 10px; margin-bottom: 8px; border-radius: 5px; cursor: grab; display: inline-block; margin-right: 5px; touch-action: none; user-select: none; z-index: 10; }
        .draggable.dragging { opacity: 0.5; border: 2px dashed var(--primary-blue); }
        #items-to-sort { margin-top: 20px; padding: 10px; background: var(--tab-bg); border-radius: 8px; min-height: 60px; }

        /* Flashcards */
        .flashcard-app { display: flex; flex-direction: column; align-items: center; }
        .flashcard-container { width: 90%; max-width: 500px; height: 300px; perspective: 1000px; margin-bottom: 20px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 10px; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; border-radius: 10px; box-sizing: border-box; font-size: 1.4em; overflow: hidden; }
        .card-front { background: var(--container-bg); border: 2px solid var(--primary-blue); color: var(--text-color); }
        .card-back { background: var(--light-gray-bg); border: 2px solid var(--green); color: var(--dark-blue); transform: rotateY(180deg); }
        .card-back p { margin: 10px 0 0; font-size: 0.8em; color: var(--text-color); opacity: 0.8; }
        body.dark-mode .card-back { color: var(--text-color); }
        .flashcard-nav { display: flex; justify-content: center; gap: 20px; }
        .flashcard-nav button { font-size: 1em; font-weight: bold; }

        /* Important: Audio Icon Size & Touch Area */
        .tts-icon { 
            font-size: 1.3em; 
            cursor: pointer; 
            margin-left: 8px; 
            opacity: 0.8; 
            transition: transform 0.2s; 
            display: inline-block;
            padding: 5px; /* Hit area for touch */
        }
        .tts-icon:active { transform: scale(1.2); color: var(--primary-blue); }

        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.95em; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: left; }
    </style>
</head>
<body class="">

    <div class="container">
        <header>
            <div class="header-controls">
                <button class="control-button" onclick="toggleLang()">EN / ES</button>
                <button class="control-button" onclick="toggleTheme()">‚òÄÔ∏è/üåô</button>
            </div>
            <h1 data-lang-key="header_title">Impersonal Expressions</h1>
            <p data-lang-key="header_subtitle">General vs. Specific Actions</p>
        </header>
        
        <nav class="main-tab-nav">
            <button class="main-tab-link active" onclick="changeMainTab(event, 'tab-metaphor')" data-lang-key="tab_1">üö¶ The Concept</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-formacion')" data-lang-key="tab_2">‚úçÔ∏è The Formula</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-bank')" data-lang-key="tab_bank">üìö Phrase Bank</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-practica')" data-lang-key="tab_3">üß† Interactive Practice</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-flashcards')" data-lang-key="tab_4">üìá Flashcards</button>
        </nav>

        <main>
            <div id="tab-metaphor" class="main-tab-content is-active">
                <h2 data-lang-key="metaphor_title">General vs. Specific</h2>
                
                <div class="comparison-grid">
                    <div class="tense-box">
                        <span class="icon-wrapper">üì£</span>
                        <h3 style="color: var(--green);" data-lang-key="cond_title">General (To everyone)</h3>
                        <p>No specific subject involved.</p>
                        <p><em>"Es importante <strong>reciclar</strong>."</em></p>
                    </div>
                    <div class="tense-box">
                        <span class="icon-wrapper">üéØ</span>
                        <h3 style="color: var(--primary-blue);" data-lang-key="cmd_title">Specific (To someone)</h3>
                        <p>Targeting a specific person.</p>
                        <p><em>"Es importante que t√∫ <strong>recicles</strong>."</em></p>
                    </div>
                </div>

                <h3 style="margin-top: 30px;" data-lang-key="video_title">Video Tutorial</h3>
                <div class="video-container">
                    <div class="video-placeholder">
                         <p>Your video tutorial will appear here.</p>
                    </div>
                </div>

                <h3 style="margin-top: 30px;" data-lang-key="viz_title">Interactive Formula</h3>
                <div class="formula-visualizer">
                    <div class="formula-controls">
                        <label>General</label>
                        <label class="switch">
                            <input type="checkbox" id="form-toggle" onchange="toggleFormula()">
                            <span class="slider"></span>
                        </label>
                        <label>Specific</label>
                    </div>
                    <div class="formula-display">
                        <span class="formula-part">Es necesario...</span>
                        <span class="formula-part" id="formula-que" style="display: none;">que</span>
                        <span class="formula-part infinitive" id="formula-result"><strong>dormir</strong> bien.</span>
                    </div>
                </div>
            </div>

            <div id="tab-formacion" class="main-tab-content">
                <h2 data-lang-key="form_title">The Structure</h2>
                
                <div class="comparison-grid">
                    <div class="tense-box" style="border-top: 4px solid var(--green);">
                        <h3>1. General Statement</h3>
                        <p><strong>Es + Adjective + INFINITIVE</strong></p>
                        <ul style="text-align:left;">
                            <li>Es bueno <strong>comer</strong> fruta.</li>
                            <li>Es dif√≠cil <strong>aprender</strong> chino.</li>
                            <li>Es urgente <strong>ayudar</strong>.</li>
                        </ul>
                    </div>
                    <div class="tense-box" style="border-top: 4px solid var(--primary-blue);">
                        <h3>2. Specific Statement</h3>
                        <p><strong>Es + Adj + QUE + SUBJUNCTIVE</strong></p>
                        <ul style="text-align:left;">
                            <li>Es bueno <strong>que comas</strong> fruta.</li>
                            <li>Es dif√≠cil <strong>que aprendas</strong> chino.</li>
                            <li>Es urgente <strong>que ayudemos</strong>.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="tab-bank" class="main-tab-content">
                <h2 data-lang-key="bank_title">Adjective Bank</h2>
                <p data-lang-key="bank_desc">Common impersonal expressions.</p>
                
                <div class="bank-controls">
                    <label>Filter:</label>
                    <select id="impSelect">
                        <option value="all">All Adjectives</option>
                    </select>
                </div>
                <div id="impBankContainer" class="comparison-grid" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
            </div>

            <div id="explain-modal" onclick="if(event.target === this) closeModal()">
                <div class="modal-content">
                    <span class="modal-close" onclick="closeModal()">&times;</span>
                    <h2 id="modal-title">Expression</h2>
                    
                    <div class="explain-block" style="border-left: 4px solid var(--green); padding-left:10px; margin-bottom:15px;">
                        <h4>üì£ General (Infinitive)</h4>
                        <p class="explain-label">Example:</p>
                        <span class="explain-ex" id="modal-gen-ex">-</span>
                    </div>
                    
                    <div class="explain-block" style="border-left: 4px solid var(--primary-blue); padding-left:10px;">
                        <h4>üéØ Specific (Subjunctive)</h4>
                        <p class="explain-label">Example:</p>
                        <span class="explain-ex" id="modal-spec-ex">-</span>
                    </div>
                </div>
            </div>

            <div id="tab-practica" class="main-tab-content">
                <h2 data-lang-key="practice_main_title">Interactive Practice</h2>
                
                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="quiz_title">Part 1: Quick Quiz</h3>
                        <button id="generate-quiz" class="refresh-btn button-secondary" data-lang-key="btn_new">New Quiz</button>
                    </div>
                    <div class="explanatory-note" data-lang-key="quiz_note">Note: Audio reads infinitives.</div>
                    <div id="quiz-container"></div>
                </div>

                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="story_title">Part 2: Story Completion</h3>
                        <button id="generate-story" class="refresh-btn button-secondary" data-lang-key="btn_new_story">New Story</button>
                    </div>
                    <div id="story-container" class="interactive-story"></div>
                    <button id="check-story-btn" class="button-primary" style="margin-top: 20px;" data-lang-key="btn_check">Check Story</button>
                </div>

                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="drag_title">Part 3: Sentence Sorter</h3>
                        <button id="generate-drag" class="refresh-btn button-secondary" data-lang-key="btn_new_match">New Matcher</button>
                    </div>
                    <p data-lang-key="drag_desc">Is it General (Infinitive) or Specific (Subjunctive)?</p>
                    <div id="items-to-sort">
                        <div id="drag-items-pool"></div>
                    </div>
                    <div class="sorter-container">
                        <div class="dropzone" id="zone-general"><h4 style="color: var(--green);">General (Infinitive)</h4></div>
                        <div class="dropzone" id="zone-specific"><h4 style="color: var(--primary-blue);">Specific (Subjunctive)</h4></div>
                    </div>
                    <button id="check-drag-btn" class="button-primary" style="margin-top: 20px;" data-lang-key="btn_check_match">Check Matches</button>
                    <div id="drag-feedback" class="feedback"></div>
                </div>
            </div>

            <div id="tab-flashcards" class="main-tab-content">
                <h2>Flashcards</h2>
                <div class="flashcard-app">
                    <div class="flashcard-container">
                        <div class="flashcard" id="flashcard">
                            <div class="card-face card-front" id="card-front"></div>
                            <div class="card-face card-back" id="card-back"></div>
                        </div>
                    </div>
                    <div class="flashcard-nav">
                        <button onclick="prevCard()" class="button-secondary" data-lang-key="btn_prev">Previous</button>
                        <button onclick="flipCard()" class="button-primary" data-lang-key="btn_flip">Flip</button>
                        <button onclick="nextCard()" class="button-secondary" data-lang-key="btn_next">Next</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

<script>

// --- GLOBAL AUDIO UTILS (iOS Optimized) ---
function speak(txt) {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel(); // Critical for iOS
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'es-ES';
        u.rate = 0.9; // Slightly slower for clarity
        window.speechSynthesis.speak(u);
    }
}

// --- GLOBAL LISTENER for all Audio Icons ---
document.addEventListener('click', function(e) {
    const target = e.target.closest('.tts-icon');
    if (target) {
        e.stopPropagation(); // Prevent flip or other actions
        e.preventDefault();
        const text = target.dataset.tts;
        if (text) speak(text);
    }
});

function toggleTheme() { document.body.classList.toggle('dark-mode'); }
function closeModal() { document.getElementById('explain-modal').style.display = 'none'; }

// --- BANK RENDERER (With Data Attributes) ---
function renderBank() {
    const container = document.getElementById('impBankContainer');
    const select = document.getElementById('impSelect');
    if(container.innerHTML.trim() !== "") return;

    impersonalDB.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.adj; opt.textContent = item.adj;
        select.appendChild(opt);
        
        const dataStr = encodeURIComponent(JSON.stringify(item));
        const card = `
        <div class="verb-card" data-adj="${item.adj}">
            <div class="verb-header">
                <span class="verb-title">Es ${item.adj}</span>
                <div>
                    <span class="verb-tag">${item.trans}</span>
                    <button class="btn-explain" onclick="showExplanation('${dataStr}')">üí° Examples</button>
                </div>
            </div>
        </div>`;
        container.innerHTML += card;
    });

    select.addEventListener('change', (e) => {
        const val = e.target.value;
        document.querySelectorAll('.verb-card').forEach(c => {
            c.style.display = (val === 'all' || c.dataset.adj === val) ? '' : 'none';
        });
    });
}

window.showExplanation = function(dataStr) {
    const data = JSON.parse(decodeURIComponent(dataStr));
    document.getElementById('modal-title').textContent = `Es ${data.adj}`;
    
    // Use data-tts instead of onclick
    const genClean = data.gen.replace(/<[^>]*>?/gm, '');
    const specClean = data.spec.replace(/<[^>]*>?/gm, '');
    
    document.getElementById('modal-gen-ex').innerHTML = `${data.gen} <span class="tts-icon" data-tts="${genClean}">üîä</span>`;
    document.getElementById('modal-spec-ex').innerHTML = `${data.spec} <span class="tts-icon" data-tts="${specClean}">üîä</span>`;
    
    document.getElementById('explain-modal').style.display = 'flex';
}

// --- DATA ---
const impersonalDB = [
    { adj: "bueno", trans: "good", gen: "Es bueno <strong>comer</strong> sano.", spec: "Es bueno que t√∫ <strong>comas</strong> sano." },
    { adj: "malo", trans: "bad", gen: "Es malo <strong>fumar</strong>.", spec: "Es malo que ellos <strong>fumen</strong>." },
    { adj: "necesario", trans: "necessary", gen: "Es necesario <strong>estudiar</strong>.", spec: "Es necesario que <strong>estudiemos</strong>." },
    { adj: "importante", trans: "important", gen: "Es importante <strong>llegar</strong> a tiempo.", spec: "Es importante que ella <strong>llegue</strong> a tiempo." },
    { adj: "urgente", trans: "urgent", gen: "Es urgente <strong>llamar</strong>.", spec: "Es urgente que t√∫ <strong>llames</strong>." },
    { adj: "posible", trans: "possible", gen: "Es posible <strong>ganar</strong>.", spec: "Es posible que nosotros <strong>ganemos</strong>." },
    { adj: "imposible", trans: "impossible", gen: "Es imposible <strong>hacerlo</strong>.", spec: "Es imposible que √©l lo <strong>haga</strong>." },
    { adj: "raro", trans: "strange", gen: "Es raro <strong>ver</strong> eso.", spec: "Es raro que t√∫ <strong>veas</strong> eso." },
    { adj: "triste", trans: "sad", gen: "Es triste <strong>perder</strong>.", spec: "Es triste que ellos <strong>pierdan</strong>." },
    { adj: "l√≥gico", trans: "logical", gen: "Es l√≥gico <strong>pensar</strong> as√≠.", spec: "Es l√≥gico que t√∫ <strong>pienses</strong> as√≠." },
    { adj: "justo", trans: "fair", gen: "Es justo <strong>compartir</strong>.", spec: "Es justo que nosotros <strong>compartamos</strong>." },
    { adj: "injusto", trans: "unfair", gen: "Es injusto <strong>castigar</strong>.", spec: "Es injusto que √©l la <strong>castigue</strong>." },
    { adj: "vergonzoso", trans: "shameful", gen: "Es vergonzoso <strong>mentir</strong>.", spec: "Es vergonzoso que t√∫ <strong>mientas</strong>." },
    { adj: "mejor", trans: "better", gen: "Es mejor <strong>esperar</strong>.", spec: "Es mejor que <strong>esperemos</strong>." }
];

const quizBank = [
    { q: "Es bueno (comer) verduras.", a: ["comer", "comas"], c: 0, e: "General -> Infinitive" },
    { q: "Es bueno que t√∫ (comer) verduras.", a: ["comer", "comas"], c: 1, e: "Specific -> Subjunctive" },
    { q: "Es importante (estudiar) mucho.", a: ["estudiar", "estudies"], c: 0, e: "General -> Infinitive" },
    { q: "Es importante que ella (estudiar).", a: ["estudiar", "estudie"], c: 1, e: "Specific -> Subjunctive" },
    { q: "Es necesario (dormir) 8 horas.", a: ["dormir", "duermas"], c: 0, e: "General -> Infinitive" },
    { q: "Es necesario que nosotros (dormir).", a: ["dormir", "durmamos"], c: 1, e: "Specific -> Subjunctive" },
    { q: "Es urgente (salir) ahora.", a: ["salir", "salgas"], c: 0, e: "General -> Infinitive" },
    { q: "Es urgente que t√∫ (salir).", a: ["salir", "salgas"], c: 1, e: "Specific -> Subjunctive" },
    { q: "Es posible (ver) las estrellas.", a: ["ver", "veas"], c: 0, e: "General -> Infinitive" },
    { q: "Es posible que √©l (ver) la pel√≠cula.", a: ["ver", "vea"], c: 1, e: "Specific -> Subjunctive" },
    { q: "Es triste (perder) el tiempo.", a: ["perder", "pierdas"], c: 0, e: "General -> Infinitive" },
    { q: "Es triste que ellos (perder).", a: ["perder", "pierdan"], c: 1, e: "Specific -> Subjunctive" },
    { q: "Es raro (estar) solo.", a: ["estar", "est√©s"], c: 0, e: "General -> Infinitive" },
    { q: "Es raro que t√∫ (estar) aqu√≠.", a: ["estar", "est√©s"], c: 1, e: "Specific -> Subjunctive" },
    { q: "Es mejor (esperar).", a: ["esperar", "esperes"], c: 0, e: "General -> Infinitive" },
    { q: "Es mejor que (esperar) un poco.", a: ["esperar", "esperemos"], c: 1, e: "Specific -> Subjunctive" },
    { q: "Es l√≥gico (pedir) ayuda.", a: ["pedir", "pidas"], c: 0, e: "General -> Infinitive" },
    { q: "Es l√≥gico que ella (pedir) ayuda.", a: ["pedir", "pida"], c: 1, e: "Specific -> Subjunctive" },
    { q: "Es justo (pagar) la cuenta.", a: ["pagar", "pagues"], c: 0, e: "General -> Infinitive" },
    { q: "Es justo que nosotros (pagar).", a: ["pagar", "paguemos"], c: 1, e: "Specific -> Subjunctive" }
];

const dragDropBank = [
    { text: "Es bueno <strong>leer</strong>.", type: "general" },
    { text: "Es bueno que <strong>leas</strong>.", type: "specific" },
    { text: "Es malo <strong>fumar</strong>.", type: "general" },
    { text: "Es malo que <strong>fumen</strong>.", type: "specific" },
    { text: "Es vital <strong>dormir</strong>.", type: "general" },
    { text: "Es vital que <strong>duermas</strong>.", type: "specific" },
    { text: "Es urgente <strong>ir</strong>.", type: "general" },
    { text: "Es urgente que <strong>vayas</strong>.", type: "specific" },
    { text: "Es posible <strong>llegar</strong>.", type: "general" },
    { text: "Es posible que <strong>lleguen</strong>.", type: "specific" },
    { text: "Es raro <strong>verte</strong>.", type: "general" },
    { text: "Es raro que <strong>vengas</strong>.", type: "specific" },
    { text: "Es mejor <strong>callar</strong>.", type: "general" },
    { text: "Es mejor que <strong>calles</strong>.", type: "specific" },
    { text: "Es justo <strong>ganar</strong>.", type: "general" },
    { text: "Es justo que <strong>ganen</strong>.", type: "specific" },
    { text: "Es dif√≠cil <strong>saber</strong>.", type: "general" },
    { text: "Es dif√≠cil que <strong>sepan</strong>.", type: "specific" },
    { text: "Es f√°cil <strong>hacerlo</strong>.", type: "general" },
    { text: "Es f√°cil que lo <strong>hagas</strong>.", type: "specific" },
    { text: "Es triste <strong>llorar</strong>.", type: "general" },
    { text: "Es triste que <strong>llores</strong>.", type: "specific" },
    { text: "Es l√≥gico <strong>pensar</strong>.", type: "general" },
    { text: "Es l√≥gico que <strong>pienses</strong>.", type: "specific" }
];

const flashcardData = [
    { en: "It's good to eat healthy.", es: "Es bueno <strong>comer</strong> sano.", explanation: "General -> Infinitive" },
    { en: "It's good that you eat healthy.", es: "Es bueno que t√∫ <strong>comas</strong> sano.", explanation: "Specific -> Subjunctive" },
    { en: "It's important to study.", es: "Es importante <strong>estudiar</strong>.", explanation: "General -> Infinitive" },
    { en: "It's important that we study.", es: "Es importante que <strong>estudiemos</strong>.", explanation: "Specific -> Subjunctive" },
    { en: "It's necessary to go.", es: "Es necesario <strong>ir</strong>.", explanation: "General -> Infinitive" },
    { en: "It's necessary that they go.", es: "Es necesario que ellos <strong>vayan</strong>.", explanation: "Specific -> Subjunctive" }
];

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    window.changeMainTab = function(evt, tabId) {
        document.querySelectorAll('.main-tab-content').forEach(el => el.classList.remove('is-active'));
        document.querySelectorAll('.main-tab-link').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('is-active');
        evt.currentTarget.classList.add('active');
        if (tabId === 'tab-practica') { generateQuiz(); generateDragDrop(); }
        if (tabId === 'tab-bank') renderBank();
    }

    // Quiz Logic
    window.generateQuiz = function() {
        const container = document.getElementById('quiz-container');
        container.innerHTML = '';
        [...quizBank].sort(() => 0.5 - Math.random()).slice(0, 5).forEach((q, i) => {
            const cleanQ = q.q.replace(/[()]/g, "");
            container.innerHTML += `
            <div class="quiz-question">
                <p>${i+1}. ${q.q} <span class="tts-icon" data-tts="${cleanQ}">üîä</span></p>
                <button onclick="checkQ(this, ${q.c===0})">${q.a[0]}</button>
                <button onclick="checkQ(this, ${q.c===1})">${q.a[1]}</button>
                <div class="explanation-text" style="display:none;">${q.e}</div>
            </div>`;
        });
    }
    window.checkQ = (btn, isC) => {
        btn.style.background = isC ? 'var(--green)' : 'var(--red)';
        btn.style.color = 'white';
        btn.parentElement.querySelector('.explanation-text').style.display = 'block';
    }

    // Drag Logic
    window.generateDragDrop = function() {
        const pool = document.getElementById('drag-items-pool');
        pool.innerHTML = '';
        document.querySelectorAll('.dropzone .draggable').forEach(e => e.remove());
        
        [...dragDropBank].sort(() => 0.5 - Math.random()).slice(0, 8).forEach(item => {
            const el = document.createElement('div');
            el.className = 'draggable'; el.draggable = true;
            const clean = item.text.replace(/<[^>]*>?/gm, '');
            el.innerHTML = `${item.text} <span class="tts-icon" data-tts="${clean}">üîä</span>`;
            el.dataset.type = item.type;
            
            el.addEventListener('dragstart', e => {
                e.dataTransfer.setData('type', item.type);
                e.target.classList.add('dragging');
            });
            el.addEventListener('dragend', e => e.target.classList.remove('dragging'));
            el.addEventListener('touchstart', touchStart, {passive: false});
            pool.appendChild(el);
        });
    }
    
    // Touch Logic
    let tDrag = null;
    function touchStart(e) {
        if(e.target.classList.contains('tts-icon')) return;
        tDrag = e.target.closest('.draggable');
        if(tDrag) {
            e.preventDefault();
            tDrag.classList.add('dragging');
            document.addEventListener('touchmove', touchMove, {passive:false});
            document.addEventListener('touchend', touchEnd);
        }
    }
    function touchMove(e) {
        if(!tDrag) return;
        e.preventDefault();
        const t = e.touches[0];
        tDrag.style.position = 'fixed'; tDrag.style.zIndex = 1000;
        tDrag.style.left = (t.clientX - tDrag.offsetWidth/2) + 'px';
        tDrag.style.top = (t.clientY - tDrag.offsetHeight/2) + 'px';
    }
    function touchEnd(e) {
        if(!tDrag) return;
        tDrag.style.position=''; tDrag.style.zIndex=''; tDrag.classList.remove('dragging');
        tDrag.style.display = 'none';
        const elem = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        tDrag.style.display = 'inline-block';
        const zone = elem ? elem.closest('.dropzone') : null;
        if(zone) zone.appendChild(tDrag);
        
        document.removeEventListener('touchmove', touchMove);
        document.removeEventListener('touchend', touchEnd);
        tDrag = null;
    }
    
    // Dropzones
    document.querySelectorAll('.dropzone').forEach(z => {
        z.addEventListener('dragover', e => e.preventDefault());
        z.addEventListener('drop', e => {
            e.preventDefault();
            const d = document.querySelector('.dragging');
            if(d) z.appendChild(d);
        });
    });

    window.checkDragMatches = () => {
        let c=0;
        document.querySelectorAll('.dropzone').forEach(z => {
            z.querySelectorAll('.draggable').forEach(d => {
                if(z.id.includes(d.dataset.type)) { d.style.background='#d4edda'; c++; }
                else d.style.background='#f8d7da';
            });
        });
        document.getElementById('drag-feedback').textContent = `Correct: ${c}`;
    }
    document.getElementById('check-drag-btn').onclick = checkDragMatches;

    // Flashcards
    let cIdx = 0;
    function loadCard() {
        const d = flashcardData[cIdx];
        const clean = d.es.replace(/<[^>]*>?/gm, '');
        document.getElementById('card-front').innerHTML = d.en;
        document.getElementById('card-back').innerHTML = `${d.es} <span class="tts-icon" data-tts="${clean}">üîä</span><br><small>${d.explanation}</small>`;
        document.getElementById('flashcard').classList.remove('is-flipped');
    }
    window.flipCard = () => document.getElementById('flashcard').classList.toggle('is-flipped');
    window.nextCard = () => { cIdx=(cIdx+1)%flashcardData.length; loadCard(); };
    window.prevCard = () => { cIdx=(cIdx-1+flashcardData.length)%flashcardData.length; loadCard(); };
    document.getElementById('flashcard').onclick = (e) => { if(!e.target.classList.contains('tts-icon')) flipCard(); };

    // Lang Toggle
    window.toggleLang = () => {
        currentLang = currentLang === 'en' ? 'es' : 'en';
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const k = el.dataset.langKey;
            if(uiData[currentLang][k]) el.innerHTML = uiData[currentLang][k];
        });
    }

    loadCard();
});
</script>
</body>
</html>
