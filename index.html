<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Si Clauses + Commands</title>
    
    <style>
        :root {
            /* Paleta Azul Est√°ndar */
            --primary-blue: #007bff;
            --dark-blue: #0056b3;
            --green: #28a745;
            --red: #dc3545;
            --yellow: #f0ad4e;
            
            --bg-color: #f0f4f8;
            --container-bg: #ffffff;
            --text-color: #333;
            --header-bg: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            --tab-bg: #f1f1f1;
            --tab-active-bg: var(--primary-blue);
            --tab-text: #555;
            --tab-active-text: #ffffff;
            --border-color: #dee2e6;
            --light-gray-bg: #f8f9fa;
        }

        /* Modo Oscuro */
        body.dark-mode {
            --bg-color: #121212; --container-bg: #1e1e1e; --text-color: #e0e0e0;
            --header-bg: #1e1e1e; --tab-bg: #333; --tab-active-bg: var(--primary-blue);
            --tab-text: #bbb; --tab-active-text: #ffffff; --border-color: #444; --light-gray-bg: #2a2a20;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; transition: 0.3s; overscroll-behavior: none; }
        .container { max-width: 950px; margin: 0 auto; background: var(--container-bg); border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.07); overflow: hidden; }
        header { background: var(--header-bg); color: white; padding: 20px 35px; text-align: center; position: relative; }
        header h1 { margin: 0; font-size: 2.5em; }
        header p { font-size: 1.2em; opacity: 0.9; margin: 5px 0 0; }
        .header-controls { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; }
        .control-button { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.7); color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        /* Tabs */
        .main-tab-nav { display: flex; background: var(--tab-bg); border-bottom: 3px solid var(--dark-blue); overflow-x: auto; }
        .main-tab-nav button { background: inherit; border: none; padding: 18px 20px; cursor: pointer; font-size: 1.1em; font-weight: bold; color: var(--tab-text); flex-grow: 1; white-space: nowrap; }
        .main-tab-nav button.active { background: var(--tab-active-bg); color: var(--tab-active-text); }
        .main-tab-content { display: none; padding: 30px; }
        .main-tab-content.is-active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Visuals */
        h2 { color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); padding-bottom: 5px; margin-top: 0; }
        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .tense-box { background: var(--light-gray-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; }
        .icon-wrapper { font-size: 4em; display: block; margin-bottom: 10px; }
        
        /* Visualizer */
        .formula-visualizer { background: var(--light-gray-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; margin-top: 20px; }
        .formula-row { display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
        .formula-card { padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1.2em; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .fc-condition { background: #e8f5e9; color: #2e7d32; border: 2px solid #2e7d32; }
        .fc-arrow { font-size: 1.5em; color: #555; }
        .fc-command { background: #e3f2fd; color: #1565c0; border: 2px solid #1565c0; }

        /* Bank Styles */
        .bank-controls { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; background: var(--light-gray-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .bank-controls select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; min-width: 200px; background: var(--container-bg); color: var(--text-color); }
        .verb-card { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; cursor: pointer; }
        .verb-card:hover { transform: translateY(-3px); border-color: var(--primary-blue); }
        .verb-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }
        .verb-title { font-size: 1.3em; font-weight: bold; color: var(--primary-blue); text-transform: capitalize; }
        .verb-tag { background: var(--light-gray-bg); color: #666; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; border: 1px solid var(--border-color); }
        .cmd-person { color: #888; width: 40%; font-size: 0.9em; }
        .cmd-form { font-weight: bold; color: var(--text-color); cursor: pointer; }
        .cmd-form.neg { color: var(--red); }
        .btn-explain { background: var(--yellow); color: #333; border: none; padding: 3px 10px; border-radius: 15px; font-size: 0.8em; cursor: pointer; font-weight: bold; margin-left: 10px; }
        
        /* Modal */
        #explain-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--container-bg); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 2px solid var(--primary-blue); color: var(--text-color); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-close { position: absolute; top: 10px; right: 20px; font-size: 2.5em; font-weight: bold; cursor: pointer; color: #666; line-height: 0.8; }
        .modal-close:hover { color: var(--red); }
        .explain-block { margin-bottom: 20px; border-left: 4px solid var(--border-color); padding-left: 15px; }
        .explain-block h4 { margin: 0 0 5px 0; }
        .explain-ex { font-style: italic; background: var(--light-gray-bg); padding: 5px; border-radius: 4px; display: inline-block; margin-top: 5px; }

        /* Practice */
        .quiz-section { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed var(--border-color); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .refresh-btn { font-size: 0.9em; padding: 5px 10px; background: var(--primary-blue); color: white; border:none; border-radius: 4px; cursor: pointer; }
        .quiz-question { background: var(--light-gray-bg); padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid var(--primary-blue); }
        .quiz-question button { background: var(--container-bg); border: 1px solid var(--primary-blue); color: var(--primary-blue); padding: 8px 15px; margin-right: 10px; border-radius: 5px; cursor: pointer; margin-top: 5px; }
        .quiz-question button:hover { background: var(--primary-blue); color: white; }
        .feedback { font-weight: bold; margin-left: 10px; }
        .correct { color: var(--green); } .incorrect { color: var(--red); }
        .explanation-text { font-size: 0.9em; color: #555; margin-top: 10px; padding: 8px; background: #e9ecef; border-radius: 4px; }
        .explanatory-note { font-size: 0.9em; font-style: italic; background: var(--light-gray-bg); padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px dashed var(--border-color); }

        /* Story */
        .interactive-story { background: #fffbe6; border: 1px solid #ffe58f; padding: 20px; border-radius: 8px; font-size: 1.1em; line-height: 2; }
        .interactive-story select { padding: 2px 5px; border: 1px solid #ccc; border-radius: 4px; }
        body.dark-mode .interactive-story { background: #2c2c20; border-color: #444; color: #eee; }
        
        /* Drag Drop */
        .sorter-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .dropzone { min-height: 200px; background: var(--light-gray-bg); border: 3px dashed var(--border-color); border-radius: 8px; padding: 10px; position: relative; }
        .dropzone h4 { text-align: center; margin-top: 0; color: var(--dark-blue); pointer-events: none; }
        .draggable { background: var(--container-bg); border: 1px solid #ccc; padding: 10px; margin-bottom: 8px; border-radius: 5px; cursor: grab; display: inline-block; margin-right: 5px; touch-action: none; user-select: none; z-index: 10; }
        .draggable.dragging { opacity: 0.5; border: 2px dashed var(--primary-blue); }
        #items-to-sort { margin-top: 20px; padding: 10px; background: var(--tab-bg); border-radius: 8px; min-height: 60px; }

        /* Flashcards */
        .flashcard-app { display: flex; flex-direction: column; align-items: center; }
        .flashcard-container { width: 90%; max-width: 500px; height: 300px; perspective: 1000px; margin-bottom: 20px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 10px; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; border-radius: 10px; box-sizing: border-box; font-size: 1.4em; overflow: hidden; }
        .card-front { background: var(--container-bg); border: 2px solid var(--primary-blue); color: var(--text-color); }
        .card-back { background: var(--light-gray-bg); border: 2px solid var(--green); color: var(--dark-blue); transform: rotateY(180deg); }
        .card-back p { margin: 10px 0 0; font-size: 0.8em; color: var(--text-color); opacity: 0.8; }
        body.dark-mode .card-back { color: var(--text-color); }
        .flashcard-nav { display: flex; justify-content: center; gap: 20px; }
        .flashcard-nav button { font-size: 1em; font-weight: bold; }

        /* Command Formation Box */
        .command-formation-box { background: #e3f2fd; border: 2px solid #2196f3; padding: 20px; border-radius: 10px; margin-bottom: 30px; text-align: center; }
        body.dark-mode .command-formation-box { background: #102a44; border-color: #0d47a1; }
        .command-example { font-size: 1.2em; margin: 10px 0; }
        .cmd-highlight { color: #d32f2f; font-weight: bold; text-decoration: underline; }

        /* Audio Icon */
        .tts-icon { font-size: 1.3em; cursor: pointer; margin-left: 8px; opacity: 0.8; display: inline-block; padding: 5px; transition: transform 0.2s; }
        .tts-icon:active { transform: scale(1.2); color: var(--primary-blue); }

        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.95em; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: left; }
    </style>
</head>
<body class="">

    <div class="container">
        <header>
            <div class="header-controls">
                <button class="control-button" onclick="toggleLang()">EN / ES</button>
                <button class="control-button" onclick="toggleTheme()">‚òÄÔ∏è/üåô</button>
            </div>
            <h1 data-lang-key="header_title">Si Clauses + Commands</h1>
            <p data-lang-key="header_subtitle">Giving Advice & Instructions</p>
        </header>
        
        <nav class="main-tab-nav">
            <button class="main-tab-link active" onclick="changeMainTab(event, 'tab-metaphor')" data-lang-key="tab_1">üö¶ The Concept</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-formacion')" data-lang-key="tab_2">‚úçÔ∏è The Formula</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-bank')" data-lang-key="tab_bank">üìö Command Bank</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-practica')" data-lang-key="tab_3">üß† Interactive Practice</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-flashcards')" data-lang-key="tab_4">üìá Flashcards</button>
        </nav>

        <main>
            <div id="tab-metaphor" class="main-tab-content is-active">
                <h2 data-lang-key="metaphor_title">Condition & Reaction</h2>
                
                <div class="comparison-grid">
                    <div class="tense-box">
                        <span class="icon-wrapper">ü§î</span>
                        <h3 style="color: var(--green);" data-lang-key="cond_title">The Condition (Si...)</h3>
                        <p data-lang-key="metaphor_cond">If a specific situation happens...</p>
                        <p><em>"Si <strong>tienes</strong> fr√≠o..."</em></p>
                    </div>
                    <div class="tense-box">
                        <span class="icon-wrapper">üëâ</span>
                        <h3 style="color: var(--primary-blue);" data-lang-key="cmd_title">The Command (¬°Hazlo!)</h3>
                        <p data-lang-key="metaphor_cmd">...do this action immediately.</p>
                        <p><em>"¬°<strong>Ponte</strong> un abrigo!"</em></p>
                    </div>
                </div>

                <h3 style="margin-top: 30px;" data-lang-key="viz_title">Interactive Formula</h3>
                <div class="formula-visualizer">
                    <p data-lang-key="viz_desc">Click the condition to see the command.</p>
                    <div class="formula-row">
                        <div class="formula-card fc-condition" onclick="toggleViz()">Si (t√∫) <strong>vas</strong> a la fiesta...</div>
                        <div class="fc-arrow">‚û°Ô∏è</div>
                        <div class="formula-card fc-command" id="viz-result">???</div>
                    </div>
                </div>
            </div>

            <div id="tab-formacion" class="main-tab-content">
                <h2 data-lang-key="form_title">The Structure</h2>
                
                <div class="command-formation-box">
                    <h3 data-lang-key="form_rule_title">How to Form Regular Commands (T√∫)</h3>
                    <p data-lang-key="form_rule_desc">It's easy! Use the <strong>3rd Person Singular (√âl/Ella)</strong> form of the Present Tense.</p>
                    <div class="comparison-grid">
                        <div class="tense-box">
                            <h4 data-lang-key="ar_verbs">-AR Verbs</h4>
                            <p>Hablar &rarr; √âl <strong>habla</strong></p>
                            <p class="command-example">¬°<span class="cmd-highlight">Habla</span> m√°s alto! <span class="tts-icon" data-tts="Habla m√°s alto">üîä</span></p>
                        </div>
                        <div class="tense-box">
                            <h4 data-lang-key="er_ir_verbs">-ER / -IR Verbs</h4>
                            <p>Comer &rarr; Ella <strong>come</strong></p>
                            <p class="command-example">¬°<span class="cmd-highlight">Come</span> tu comida! <span class="tts-icon" data-tts="Come tu comida">üîä</span></p>
                        </div>
                    </div>
                </div>

                <div class="comparison-grid">
                    <div class="tense-box" style="border-top: 4px solid var(--green);">
                        <h3>1. The Clause (Si + Present)</h3>
                        <p>Use the <strong>Present Indicative</strong>.</p>
                        <ul style="text-align:left;">
                            <li>Si <strong>tienes</strong> tiempo...</li>
                            <li>Si <strong>vas</strong> al cine...</li>
                        </ul>
                    </div>
                    <div class="tense-box" style="border-top: 4px solid var(--primary-blue);">
                        <h3>2. The Command (Imperative)</h3>
                        <p>Use the <strong>Imperative (Mandato)</strong>.</p>
                        <ul style="text-align:left;">
                            <li>...<strong>ll√°mame</strong>.</li>
                            <li>...<strong>compra</strong> palomitas.</li>
                        </ul>
                    </div>
                </div>

                <h3>Key Irregular Commands (T√∫)</h3>
                <p>Memorize these short forms (Vin Diesel has ten weapons):</p>
                <table>
                    <tr><th>Infinitive</th><th>Command (T√∫)</th></tr>
                    <tr><td>Venir</td><td><strong>Ven</strong> <span class="tts-icon" data-tts="Ven">üîä</span></td></tr>
                    <tr><td>Decir</td><td><strong>Di</strong> <span class="tts-icon" data-tts="Di">üîä</span></td></tr>
                    <tr><td>Salir</td><td><strong>Sal</strong> <span class="tts-icon" data-tts="Sal">üîä</span></td></tr>
                    <tr><td>Hacer</td><td><strong>Haz</strong> <span class="tts-icon" data-tts="Haz">üîä</span></td></tr>
                    <tr><td>Tener</td><td><strong>Ten</strong> <span class="tts-icon" data-tts="Ten">üîä</span></td></tr>
                    <tr><td>Ir</td><td><strong>Ve</strong> <span class="tts-icon" data-tts="Ve">üîä</span></td></tr>
                    <tr><td>Poner</td><td><strong>Pon</strong> <span class="tts-icon" data-tts="Pon">üîä</span></td></tr>
                    <tr><td>Ser</td><td><strong>S√©</strong> <span class="tts-icon" data-tts="S√©">üîä</span></td></tr>
                </table>
            </div>

            <div id="tab-bank" class="main-tab-content">
                <h2 data-lang-key="bank_title">Command Bank</h2>
                <p data-lang-key="bank_desc">Reference for regular and irregular commands.</p>
                
                <div class="bank-controls">
                    <label>Filter:</label>
                    <select id="cmdVerbSelect">
                        <option value="all">All Verbs</option>
                    </select>
                </div>
                <div id="cmdBankContainer"></div>
            </div>

            <div id="explain-modal" onclick="if(event.target === this) closeModal()">
                <div class="modal-content">
                    <span class="modal-close" onclick="closeModal()">&times;</span>
                    <h2 id="modal-title">Verb</h2>
                    <p id="modal-trans" style="font-style:italic; color:#666; margin-bottom:20px;">Translation</p>
                    
                    <div class="explain-block" style="border-left: 4px solid var(--green); padding-left:10px;">
                        <h4>‚úÖ Affirmative (T√∫)</h4>
                        <p><span id="modal-aff-form" style="font-size:1.5em; font-weight:bold;">-</span></p>
                        <span class="explain-ex" id="modal-aff-ex">-</span>
                    </div>
                    
                    <div class="explain-block" style="border-left: 4px solid var(--red); padding-left:10px;">
                        <h4>‚ùå Negative (T√∫)</h4>
                        <p><span id="modal-neg-form" style="font-size:1.5em; font-weight:bold;">-</span></p>
                        <span class="explain-ex" id="modal-neg-ex">-</span>
                    </div>
                </div>
            </div>

            <div id="tab-practica" class="main-tab-content">
                <h2 data-lang-key="practice_main_title">Interactive Practice</h2>
                
                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="quiz_title">Part 1: Quick Quiz</h3>
                        <button id="generate-quiz" class="refresh-btn button-secondary" data-lang-key="btn_new">New Quiz</button>
                    </div>
                    <div class="explanatory-note" data-lang-key="quiz_note">Note: Audio reads infinitives to avoid spoilers.</div>
                    <div id="quiz-container"></div>
                </div>

                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="story_title">Part 2: Advice Story</h3>
                        <button id="generate-story" class="refresh-btn button-secondary" data-lang-key="btn_new_story">New Story</button>
                    </div>
                    <div id="story-container" class="interactive-story"></div>
                    <button id="check-story-btn" class="button-primary" style="margin-top: 20px;" data-lang-key="btn_check">Check Story</button>
                </div>

                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="drag_title">Part 3: Logic Matcher</h3>
                        <button id="generate-drag" class="refresh-btn button-secondary" data-lang-key="btn_new_match">New Matcher</button>
                    </div>
                    <p data-lang-key="drag_desc">Match the <strong>Condition</strong> (Green) with the logical <strong>Command</strong> (Blue).</p>
                    <div id="items-to-sort">
                        <div id="drag-items-pool"></div>
                    </div>
                    <div class="sorter-container">
                        <div class="dropzone" id="zone-condition"><h4 style="color: var(--green);">If... (Condition)</h4></div>
                        <div class="dropzone" id="zone-command"><h4 style="color: var(--primary-blue);">Then... (Command)</h4></div>
                    </div>
                    <button id="check-drag-btn" class="button-primary" style="margin-top: 20px;" data-lang-key="btn_check_match">Check Matches</button>
                    <div id="drag-feedback" class="feedback"></div>
                </div>
            </div>

            <div id="tab-flashcards" class="main-tab-content">
                <h2>Flashcards</h2>
                <div class="flashcard-app">
                    <div class="flashcard-container">
                        <div class="flashcard" id="flashcard">
                            <div class="card-face card-front" id="card-front"></div>
                            <div class="card-face card-back" id="card-back"></div>
                        </div>
                    </div>
                    <div class="flashcard-nav">
                        <button onclick="prevCard()" class="button-secondary" data-lang-key="btn_prev">Previous</button>
                        <button onclick="flipCard()" class="button-primary" data-lang-key="btn_flip">Flip</button>
                        <button onclick="nextCard()" class="button-secondary" data-lang-key="btn_next">Next</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>

// --- GLOBAL AUDIO UTILS (iOS Optimized) ---
function speak(txt) {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel(); 
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'es-ES';
        u.rate = 0.9; 
        window.speechSynthesis.speak(u);
    }
}

// GLOBAL LISTENER FOR AUDIO (IPAD FIX)
document.addEventListener('click', function(e) {
    const target = e.target.closest('.tts-icon');
    if (target) {
        e.stopPropagation();
        e.preventDefault();
        const text = target.dataset.tts;
        if (text) speak(text);
    }
});

function toggleTheme() { document.body.classList.toggle('dark-mode'); }
function closeModal() { document.getElementById('explain-modal').style.display = 'none'; }

// --- BANK RENDERER ---
function conjugateCmdRegular(verb) {
    const stem = verb.slice(0, -2);
    const end = verb.slice(-2);
    if (end === "ar") return [stem+"a", "no "+stem+"es", stem+"e", stem+"en", stem+"emos"];
    if (end === "er") return [stem+"e", "no "+stem+"as", stem+"a", stem+"an", stem+"amos"];
    if (end === "ir") return [stem+"e", "no "+stem+"as", stem+"a", stem+"an", stem+"amos"]; 
    return ["-","-","-","-","-"];
}

function renderBank() {
    const container = document.getElementById('cmdBankContainer');
    const select = document.getElementById('cmdVerbSelect');
    if(container.innerHTML.trim() !== "") return;

    commandDatabase.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.verb; opt.textContent = item.verb;
        select.appendChild(opt);
        
        if(item.auto) item.forms = conjugateCmdRegular(item.verb);
        const dataStr = encodeURIComponent(JSON.stringify(item));
        
        const card = `
        <div class="verb-card" data-verb="${item.verb}">
            <div class="verb-header">
                <span class="verb-title">${item.verb}</span>
                <div>
                    <span class="verb-tag">${item.tag}</span>
                    <button class="btn-explain" onclick="showExplanation('${dataStr}')">üí° Explain</button>
                </div>
            </div>
            <table>
                <tr><td class="cmd-person">T√∫ (Afirm)</td><td class="cmd-form">${item.forms[0]} <span class="tts-icon" data-tts="${item.forms[0]}">üîä</span></td></tr>
                <tr><td class="cmd-person">T√∫ (Neg)</td><td class="cmd-form neg">${item.forms[1]} <span class="tts-icon" data-tts="${item.forms[1]}">üîä</span></td></tr>
                <tr><td class="cmd-person">Usted</td><td class="cmd-form">${item.forms[2]} <span class="tts-icon" data-tts="${item.forms[2]}">üîä</span></td></tr>
                <tr><td class="cmd-person">Ustedes</td><td class="cmd-form">${item.forms[3]} <span class="tts-icon" data-tts="${item.forms[3]}">üîä</span></td></tr>
                <tr><td class="cmd-person">Nosotros</td><td class="cmd-form">${item.forms[4]} <span class="tts-icon" data-tts="${item.forms[4]}">üîä</span></td></tr>
            </table>
        </div>`;
        container.innerHTML += card;
    });

    select.addEventListener('change', (e) => {
        const val = e.target.value;
        document.querySelectorAll('.verb-card').forEach(c => {
            c.style.display = (val === 'all' || c.dataset.verb === val) ? '' : 'none';
        });
    });
}

window.showExplanation = function(dataStr) {
    const data = JSON.parse(decodeURIComponent(dataStr));
    document.getElementById('modal-title').textContent = data.verb.charAt(0).toUpperCase() + data.verb.slice(1);
    document.getElementById('modal-trans').textContent = data.trans;
    
    document.getElementById('modal-aff-form').textContent = data.forms[0];
    document.getElementById('modal-aff-ex').innerHTML = `Ex: "${data.ex_aff}" <span class="tts-icon" data-tts="${data.ex_aff}">üîä</span>`;
    
    document.getElementById('modal-neg-form').textContent = data.forms[1];
    document.getElementById('modal-neg-ex').innerHTML = `Ex: "${data.ex_neg}" <span class="tts-icon" data-tts="${data.ex_neg}">üîä</span>`;
    
    document.getElementById('explain-modal').style.display = 'flex';
}

// --- DATA ---
const uiData = {
    en: {
        header_title: "Si Clauses + Commands",
        header_subtitle: "Giving Advice & Instructions",
        tab_1: "üö¶ The Concept",
        tab_2: "‚úçÔ∏è The Formula",
        tab_bank: "üìö Command Bank",
        tab_3: "üß† Interactive Practice",
        tab_4: "üìá Flashcards",
        metaphor_title: "Condition & Reaction",
        cond_title: "The Condition (Si...)",
        metaphor_cond: "If a specific situation happens...",
        cmd_title: "The Command (Do it!)",
        metaphor_cmd: "...do this action immediately.",
        video_title: "Video Tutorial",
        viz_title: "Interactive Formula",
        viz_desc: "Click the condition to see the command.",
        form_title: "The Structure",
        form_rule_title: "How to Form Regular Commands (T√∫)",
        form_rule_desc: "It's easy! Use the <strong>3rd Person Singular (√âl/Ella)</strong> form of the Present Tense.",
        ar_verbs: "-AR Verbs",
        er_ir_verbs: "-ER / -IR Verbs",
        bank_title: "Command Bank",
        bank_desc: "Reference for regular and irregular commands.",
        practice_main_title: "Interactive Practice",
        quiz_title: "Part 1: Quick Quiz",
        btn_new: "New Quiz",
        quiz_note: "Note: Audio reads infinitives to avoid spoilers.",
        story_title: "Part 2: Advice Story",
        btn_new_story: "New Story",
        btn_check: "Check Story",
        drag_title: "Part 3: Logic Matcher",
        btn_new_match: "New Matcher",
        drag_desc: "Match the Condition (Green) with the logical Command (Blue).",
        btn_check_match: "Check Matches",
        btn_prev: "Previous",
        btn_flip: "Flip",
        btn_next: "Next"
    },
    es: {
        header_title: "Si + Mandatos",
        header_subtitle: "Dar Consejos e Instrucciones",
        tab_1: "üö¶ El Concepto",
        tab_2: "‚úçÔ∏è La F√≥rmula",
        tab_bank: "üìö Banco de Mandatos",
        tab_3: "üß† Pr√°ctica Interactiva",
        tab_4: "üìá Flashcards",
        metaphor_title: "Condici√≥n y Reacci√≥n",
        cond_title: "La Condici√≥n (Si...)",
        metaphor_cond: "Si ocurre una situaci√≥n...",
        cmd_title: "El Mandato (¬°Hazlo!)",
        metaphor_cmd: "...haz esta acci√≥n inmediatamente.",
        video_title: "Video Tutorial",
        viz_title: "F√≥rmula Interactiva",
        viz_desc: "Haz clic en la condici√≥n para ver el mandato.",
        form_title: "La Estructura",
        form_rule_title: "C√≥mo Formar Mandatos Regulares (T√∫)",
        form_rule_desc: "¬°Es f√°cil! Usa la forma de <strong>3¬™ Persona Singular (√âl/Ella)</strong> del Presente.",
        ar_verbs: "Verbos -AR",
        er_ir_verbs: "Verbos -ER / -IR",
        bank_title: "Banco de Mandatos",
        bank_desc: "Referencia de mandatos regulares e irregulares.",
        practice_main_title: "Pr√°ctica Interactiva",
        quiz_title: "Parte 1: Quiz R√°pido",
        btn_new: "Nuevo Quiz",
        quiz_note: "Nota: El audio lee infinitivos para no revelar la respuesta.",
        story_title: "Parte 2: Historia de Consejos",
        btn_new_story: "Nueva Historia",
        btn_check: "Verificar Historia",
        drag_title: "Parte 3: Parejas L√≥gicas",
        btn_new_match: "Nuevo Juego",
        drag_desc: "Une la Condici√≥n (Verde) con el Mandato l√≥gico (Azul).",
        btn_check_match: "Verificar Parejas",
        btn_prev: "Anterior",
        btn_flip: "Voltear",
        btn_next: "Siguiente"
    }
};

let currentLang = 'en';

// --- COMMAND DATABASE ---
const commandDatabase = [
    { verb: "hablar", tag: "Regular -AR", auto: true, trans: "To speak", ex_aff: "¬°Habla m√°s alto!", ex_neg: "¬°No hables en clase!" },
    { verb: "comer", tag: "Regular -ER", auto: true, trans: "To eat", ex_aff: "¬°Come tus verduras!", ex_neg: "¬°No comas eso!" },
    { verb: "vivir", tag: "Regular -IR", auto: true, trans: "To live", ex_aff: "¬°Vive la vida!", ex_neg: "¬°No vivas con miedo!" },
    { verb: "escuchar", tag: "Regular -AR", auto: true, trans: "To listen", ex_aff: "¬°Escucha al profesor!", ex_neg: "¬°No escuches m√∫sica ahora!" },
    { verb: "venir", tag: "Irregular", auto: false, forms: ["ven", "no vengas", "venga", "vengan", "vengamos"], trans: "To come", ex_aff: "¬°Ven aqu√≠!", ex_neg: "¬°No vengas tarde!" },
    { verb: "decir", tag: "Irregular", auto: false, forms: ["di", "no digas", "diga", "digan", "digamos"], trans: "To say/tell", ex_aff: "¬°Di la verdad!", ex_neg: "¬°No digas mentiras!" },
    { verb: "salir", tag: "Irregular", auto: false, forms: ["sal", "no salgas", "salga", "salgan", "salgamos"], trans: "To leave/go out", ex_aff: "¬°Sal de ah√≠!", ex_neg: "¬°No salgas sin chaqueta!" },
    { verb: "hacer", tag: "Irregular", auto: false, forms: ["haz", "no hagas", "haga", "hagan", "hagamos"], trans: "To do/make", ex_aff: "¬°Haz tu tarea!", ex_neg: "¬°No hagas ruido!" },
    { verb: "tener", tag: "Irregular", auto: false, forms: ["ten", "no tengas", "tenga", "tengan", "tengamos"], trans: "To have", ex_aff: "¬°Ten paciencia!", ex_neg: "¬°No tengas miedo!" },
    { verb: "ir", tag: "Irregular", auto: false, forms: ["ve", "no vayas", "vaya", "vayan", "vayamos"], trans: "To go", ex_aff: "¬°Ve a la escuela!", ex_neg: "¬°No vayas solo!" },
    { verb: "poner", tag: "Irregular", auto: false, forms: ["pon", "no pongas", "ponga", "pongan", "pongamos"], trans: "To put", ex_aff: "¬°Pon la mesa!", ex_neg: "¬°No pongas los pies ah√≠!" },
    { verb: "ser", tag: "Irregular", auto: false, forms: ["s√©", "no seas", "sea", "sean", "seamos"], trans: "To be", ex_aff: "¬°S√© amable!", ex_neg: "¬°No seas grosero!" },
    { verb: "empacar", tag: "Orthographic (-car)", auto: false, forms: ["empaca", "no empaques", "empaque", "empaquen", "empaquemos"], trans: "To pack", ex_aff: "¬°Empaca tu maleta!", ex_neg: "¬°No empaques todo eso!" }
];

const quizBank = [
    { q: "Si (tener) tiempo, (llamar) a Mar√≠a.", options: ["tienes / llama", "tengas / llames"], correct: 0, explanation: "Si + Present Ind. -> Command." },
    { q: "Si (ir) al mercado, (comprar) pan.", options: ["vas / compra", "vayas / compres"], correct: 0, explanation: "Ir (vas) -> Comprar (compra)." },
    { q: "Si (ver) a Luis, (decir) la verdad.", options: ["veas / di", "ves / dile"], correct: 1, explanation: "Ver (ves) -> Decir (di + le)." },
    { q: "Si no (entender), (preguntar).", options: ["entiendes / pregunta", "entiendas / preguntes"], correct: 0, explanation: "Entender (e-ie) -> Preguntar." },
    { q: "Si (estar) cansado, (descansar).", options: ["est√°s / descansa", "est√©s / descansas"], correct: 0, explanation: "Estar (est√°s) -> Descansar." },
    { q: "Si (hacer) sol, (ponerse) crema.", options: ["hace / ponte", "haga / ponga"], correct: 0, explanation: "Hacer (hace) -> Ponerse (pon + te)." },
    { q: "Si (querer) venir, (venir).", options: ["quieres / ven", "quieras / vengas"], correct: 0, explanation: "Querer (quieres) -> Venir (ven - irreg)." },
    { q: "Si (salir), (cerrar) la puerta.", options: ["sales / cierra", "salgas / cierres"], correct: 0, explanation: "Salir (sales) -> Cerrar (cierra)." },
    { q: "Si (tener) hambre, (comer).", options: ["tienes / come", "tengas / comas"], correct: 0, explanation: "Tener -> Comer." },
    { q: "Si (ser) valiente, (hacerlo).", options: ["eres / hazlo", "seas / hazlo"], correct: 0, explanation: "Ser (eres) -> Hacer (haz + lo)." },
    { q: "Si te (doler) la cabeza, (tomar) esto.", options: ["duele / toma", "duela / tomes"], correct: 0, explanation: "Doler (duele) -> Tomar." },
    { q: "Si (buscar) paz, (meditar).", options: ["buscas / medita", "busques / medites"], correct: 0, explanation: "Buscar -> Meditar." },
    { q: "Si (necesitar) ayuda, (pedir).", options: ["necesitas / pide", "necesites / pidas"], correct: 0, explanation: "Pedir (pide)." },
    { q: "Si (sentirse) mal, (ir) al m√©dico.", options: ["te sientes / ve", "te sientas / vaya"], correct: 0, explanation: "Ir (ve - irreg)." },
    { q: "Si (romper) algo, (pagar).", options: ["rompes / paga", "rompas / pagues"], correct: 0, explanation: "Romper -> Pagar." },
    { q: "Si (escuchar) m√∫sica, (bailar).", options: ["escuchas / baila", "escuches / bailes"], correct: 0, explanation: "Escuchar -> Bailar." },
    { q: "Si (llegar) tarde, no (entrar).", options: ["llegas / entres", "llegues / entra"], correct: 0, explanation: "Negative command uses subjunctive form (no entres)." },
    { q: "Si (poder), (ayudarme).", options: ["puedes / ay√∫dame", "puedas / ayuda"], correct: 0, explanation: "Poder -> Ayudar." },
    { q: "Si (leer) esto, (compartir).", options: ["lees / comparte", "leas / compartas"], correct: 0, explanation: "Leer -> Compartir." },
    { id: "q20", q: "Si (viajar), (disfrutar).", options: ["viajas / disfruta", "viajes / disfrutes"], correct: 0, explanation: "Viajar -> Disfrutar." },
    { id: "q21", q: "Si (perder), no (llorar).", options: ["pierdes / llores", "pierdas / llora"], correct: 0, explanation: "Negative Command (no llores)." },
    { id: "q22", q: "Si (beber), no (conducir).", options: ["bebes / conduzcas", "bebas / conduces"], correct: 0, explanation: "Neg command (no conduzcas)." },
    { id: "q23", q: "Si (ver) el error, (corregir).", options: ["ves / corrige", "veas / corrigas"], correct: 0, explanation: "Ver -> Corregir." },
    { id: "q24", q: "Si (hacer) fr√≠o, (abrigarse).", options: ["hace / abr√≠gate", "haga / abrigarte"], correct: 0, explanation: "Hacer -> Abrigarse (reflexive)." },
    { id: "q25", q: "Si (querer) paz, (perdonar).", options: ["quieres / perdona", "quieras / perdonas"], correct: 0, explanation: "Querer -> Perdonar." }
];

const storyBank = [
    {
        html: `<h3>Consejos de Salud üè•</h3>
        <span>Si t√∫</span> <select data-ans="quieres"><option value="w">quieras</option><option value="c">quieres</option></select>
        <span>estar sano,</span> <select data-ans="come"><option value="c">come</option><option value="w">comas</option></select>
        <span>bien. Si te</span> <select data-ans="sientes"><option value="c">sientes</option><option value="w">sientas</option></select>
        <span>cansado,</span> <select data-ans="duerme"><option value="w">duermas</option><option value="c">duerme</option></select>
        <span>ocho horas. Si no</span> <select data-ans="tienes"><option value="c">tienes</option><option value="w">tengas</option></select>
        <span>tiempo,</span> <select data-ans="haz"><option value="c">haz</option><option value="w">hagas</option></select>
        <span>ejercicio en casa.</span>`
    },
    {
        html: `<h3>Preparando un Viaje ‚úàÔ∏è</h3>
        <span>Si</span> <select data-ans="vas"><option value="c">vas</option><option value="w">vayas</option></select>
        <span>a Espa√±a,</span> <select data-ans="visita"><option value="w">visites</option><option value="c">visita</option></select>
        <span>Madrid. Si</span> <select data-ans="necesitas"><option value="c">necesitas</option><option value="w">necesites</option></select>
        <span>ayuda,</span> <select data-ans="pregunta"><option value="c">pregunta</option><option value="w">preguntes</option></select>
        <span>a la gente. Si</span> <select data-ans="tienes"><option value="c">tienes</option><option value="w">tengas</option></select>
        <span>hambre,</span> <select data-ans="prueba"><option value="c">prueba</option><option value="w">pruebes</option></select>
        <span>las tapas.</span>`
    },
    {
        html: `<h3>En la Cocina üç≥</h3>
        <span>Si</span> <select data-ans="cocinas"><option value="c">cocinas</option><option value="w">cocines</option></select>
        <span>pasta,</span> <select data-ans="hierve"><option value="w">hirvas</option><option value="c">hierve</option></select>
        <span>el agua primero. Si</span> <select data-ans="usas"><option value="c">usas</option><option value="w">uses</option></select>
        <span>cuchillos,</span> <select data-ans="ten"><option value="c">ten</option><option value="w">tengas</option></select>
        <span>cuidado. Si</span> <select data-ans="terminas"><option value="c">terminas</option><option value="w">termines</option></select>
        <span>de comer,</span> <select data-ans="lava"><option value="c">lava</option><option value="w">laves</option></select>
        <span>los platos.</span>`
    },
    {
        html: `<h3>En la Escuela üìö</h3>
        <span>Si no</span> <select data-ans="comprendes"><option value="c">comprendes</option><option value="w">comprendas</option></select>
        <span>la lecci√≥n,</span> <select data-ans="levanta"><option value="w">levantes</option><option value="c">levanta</option></select>
        <span>la mano. Si</span> <select data-ans="quieres"><option value="c">quieres</option><option value="w">quieras</option></select>
        <span>sacar buenas notas,</span> <select data-ans="estudia"><option value="c">estudia</option><option value="w">estudies</option></select>
        <span>todos los d√≠as. Si</span> <select data-ans="sales"><option value="c">sales</option><option value="w">salgas</option></select>
        <span>tarde,</span> <select data-ans="corre"><option value="c">corre</option><option value="w">corras</option></select>
        <span>al autob√∫s.</span>`
    },
    {
        html: `<h3>Seguridad Online üîí</h3>
        <span>Si</span> <select data-ans="usas"><option value="c">usas</option><option value="w">uses</option></select>
        <span>internet,</span> <select data-ans="protege"><option value="w">protejas</option><option value="c">protege</option></select>
        <span>tu contrase√±a. Si</span> <select data-ans="ves"><option value="c">ves</option><option value="w">veas</option></select>
        <span>algo raro, no</span> <select data-ans="hagas"><option value="c">hagas</option><option value="w">haz</option></select>
        <span>clic. Si</span> <select data-ans="recibes"><option value="c">recibes</option><option value="w">recibas</option></select>
        <span>spam,</span> <select data-ans="b√≥rralo"><option value="c">b√≥rralo</option><option value="w">b√≥rrelo</option></select>
        <span>inmediatamente.</span>`
    }
];

// 24 Drag Items
const dragDropBank = [
    { text: "Si tienes fr√≠o...", type: "condition" }, { text: "¬°Ponte un abrigo!", type: "command" },
    { text: "Si est√°s cansado...", type: "condition" }, { text: "¬°Duerme un poco!", type: "command" },
    { text: "Si tienes hambre...", type: "condition" }, { text: "¬°Come una manzana!", type: "command" },
    { text: "Si te duele la cabeza...", type: "condition" }, { text: "¬°Toma una aspirina!", type: "command" },
    { text: "Si no entiendes...", type: "condition" }, { text: "¬°Pregunta al profesor!", type: "command" },
    { text: "Si vas a la playa...", type: "condition" }, { text: "¬°Usa protector solar!", type: "command" },
    { text: "Si quieres aprobar...", type: "condition" }, { text: "¬°Estudia m√°s!", type: "command" },
    { text: "Si ves un accidente...", type: "condition" }, { text: "¬°Llama a la polic√≠a!", type: "command" },
    { text: "Si llegas tarde...", type: "condition" }, { text: "¬°Corre!", type: "command" },
    { text: "Si est√°s aburrido...", type: "condition" }, { text: "¬°Lee un libro!", type: "command" },
    { text: "Si llueve...", type: "condition" }, { text: "¬°Lleva paraguas!", type: "command" },
    { text: "Si cocinas...", type: "condition" }, { text: "¬°Lava los platos!", type: "command" }
];

const flashcardData = [
    { en: "If you have time, call me.", es: "Si <strong>tienes</strong> tiempo, <strong>ll√°mame</strong>.", explanation: "Si + Present -> Command" },
    { en: "If you go to the store, buy milk.", es: "Si <strong>vas</strong> a la tienda, <strong>compra</strong> leche.", explanation: "Ir (vas) -> Comprar (compra)" },
    { en: "If you are tired, sleep.", es: "Si <strong>est√°s</strong> cansado, <strong>duerme</strong>.", explanation: "Estar (est√°s) -> Dormir (duerme)" },
    { en: "If you see Juan, tell him hi.", es: "Si <strong>ves</strong> a Juan, <strong>dile</strong> hola.", explanation: "Ver (ves) -> Decir (di - irregular)" },
    { en: "If you want to pass, study.", es: "Si <strong>quieres</strong> aprobar, <strong>estudia</strong>.", explanation: "Querer (quieres) -> Estudiar (estudia)" },
    { en: "If it rains, take an umbrella.", es: "Si <strong>llueve</strong>, <strong>lleva</strong> un paraguas.", explanation: "Llover (llueve) -> Llevar (lleva)" },
    { en: "If you are cold, put on a coat.", es: "Si <strong>tienes</strong> fr√≠o, <strong>ponte</strong> un abrigo.", explanation: "Tener (tienes) -> Ponerse (ponte - irregular)" },
    { en: "If you leave, close the door.", es: "Si <strong>sales</strong>, <strong>cierra</strong> la puerta.", explanation: "Salir (sales) -> Cerrar (cierra)" },
    { en: "If you are hungry, eat something.", es: "Si <strong>tienes</strong> hambre, <strong>come</strong> algo.", explanation: "Tener (tienes) -> Comer (come)" },
    { en: "If you don't understand, ask.", es: "Si no <strong>entiendes</strong>, <strong>pregunta</strong>.", explanation: "Entender (entiendes) -> Preguntar (pregunta)" },
    { en: "If you have a problem, tell me.", es: "Si <strong>tienes</strong> un problema, <strong>d√≠melo</strong>.", explanation: "Decir (di) + me + lo" },
    { en: "If you come early, help me.", es: "Si <strong>vienes</strong> temprano, <strong>ay√∫dame</strong>.", explanation: "Venir (vienes) -> Ayudar (ayuda)" },
    { en: "If you are sad, listen to music.", es: "Si <strong>est√°s</strong> triste, <strong>escucha</strong> m√∫sica.", explanation: "Estar (est√°s) -> Escuchar (escucha)" },
    { en: "If you make a mistake, fix it.", es: "Si <strong>haces</strong> un error, <strong>arr√©glalo</strong>.", explanation: "Hacer (haces) -> Arreglar (arregla)" },
    { en: "If you go out, be careful.", es: "Si <strong>sales</strong>, <strong>ten</strong> cuidado.", explanation: "Tener (ten - irregular)" },
    { en: "If you drive, don't drink.", es: "Si <strong>conduces</strong>, no <strong>bebas</strong>.", explanation: "Negative Command (Subjunctive form)" },
    { en: "If you visit Paris, go to the Louvre.", es: "Si <strong>visitas</strong> Par√≠s, <strong>ve</strong> al Louvre.", explanation: "Ir (ve - irregular)" },
    { en: "If you cook, clean the kitchen.", es: "Si <strong>cocinas</strong>, <strong>limpia</strong> la cocina.", explanation: "Cocinar -> Limpiar" },
    { en: "If you are bored, read a book.", es: "Si <strong>est√°s</strong> aburrido, <strong>lee</strong> un libro.", explanation: "Estar -> Leer" },
    { en: "If you love her, tell her.", es: "Si la <strong>amas</strong>, <strong>d√≠selo</strong>.", explanation: "Decir (di) + se + lo" }
];

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    window.changeMainTab = function(evt, tabId) {
        document.querySelectorAll('.main-tab-content').forEach(el => el.classList.remove('is-active'));
        document.querySelectorAll('.main-tab-link').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('is-active');
        evt.currentTarget.classList.add('active');
        if (tabId === 'tab-practica') { generateQuiz(); generateStory(); generateDragDrop(); }
        if (tabId === 'tab-bank') renderBank();
    }
    
    // Formula Viz
    window.toggleViz = function() {
        const res = document.getElementById('viz-result');
        res.textContent = "¬°¬°Ponte un abrigo!!";
        res.style.backgroundColor = "#fff9c4";
        speak("Ponte un abrigo");
        setTimeout(() => res.style.backgroundColor = "#e3f2fd", 500);
    }
    
    // Quiz
    window.generateQuiz = function() {
        const container = document.getElementById('quiz-container');
        container.innerHTML = '';
        [...quizBank].sort(() => 0.5 - Math.random()).slice(0, 5).forEach((q, i) => {
            const cleanQ = q.q.replace(/[()]/g, "");
            container.innerHTML += `
            <div class="quiz-question">
                <p>${i+1}. ${q.q} <span class="tts-icon" data-tts="${cleanQ}">üîä</span></p>
                <button onclick="checkQ(this, ${q.correct===0})">${q.options[0]}</button>
                <button onclick="checkQ(this, ${q.correct===1})">${q.options[1]}</button>
                <div class="explanation-text" style="display:none;">${q.explanation}</div>
            </div>`;
        });
    }
    window.checkQ = (btn, isC) => {
        btn.style.background = isC ? 'var(--green)' : 'var(--red)';
        btn.style.color = 'white';
        btn.parentElement.querySelector('.explanation-text').style.display = 'block';
    }
    
    // Story
    window.generateStory = function() {
        const currentStoryData = storyBank[Math.floor(Math.random() * storyBank.length)];
        document.getElementById('story-container').innerHTML = currentStoryData.html;
    }
    window.checkStory = () => {
        document.querySelectorAll('select').forEach(s => {
            const isC = s.value === s.dataset.ans;
            s.style.backgroundColor = isC ? "#d4edda" : "#f8d7da";
            s.style.borderColor = isC ? "var(--green)" : "var(--red)";
        });
    }

    // Drag
    window.generateDragDrop = function() {
        const pool = document.getElementById('drag-items-pool');
        pool.innerHTML = '';
        document.querySelectorAll('.dropzone .draggable').forEach(e => e.remove());
        
        [...dragDropBank].sort(() => 0.5 - Math.random()).slice(0, 8).forEach(item => {
            const el = document.createElement('div');
            el.className = 'draggable'; el.draggable = true;
            const clean = item.text.replace(/<[^>]*>?/gm, '');
            el.innerHTML = `${item.text} <span class="tts-icon" data-tts="${clean}">üîä</span>`;
            el.dataset.type = item.type;
            
            el.addEventListener('dragstart', e => {
                e.dataTransfer.setData('type', item.type);
                e.target.classList.add('dragging');
            });
            el.addEventListener('dragend', e => e.target.classList.remove('dragging'));
            el.addEventListener('touchstart', touchStart, {passive: false});
            pool.appendChild(el);
        });
    }
    
    // Touch Logic
    let tDrag = null;
    function touchStart(e) {
        if(e.target.classList.contains('tts-icon')) return;
        tDrag = e.target.closest('.draggable');
        if(tDrag) {
            e.preventDefault();
            tDrag.classList.add('dragging');
            document.addEventListener('touchmove', touchMove, {passive:false});
            document.addEventListener('touchend', touchEnd);
        }
    }
    function touchMove(e) {
        if(!tDrag) return;
        e.preventDefault();
        const t = e.touches[0];
        tDrag.style.position = 'fixed'; tDrag.style.zIndex = 1000;
        tDrag.style.left = (t.clientX - tDrag.offsetWidth/2) + 'px';
        tDrag.style.top = (t.clientY - tDrag.offsetHeight/2) + 'px';
    }
    function touchEnd(e) {
        if(!tDrag) return;
        tDrag.style.position=''; tDrag.style.zIndex=''; tDrag.classList.remove('dragging');
        tDrag.style.display = 'none';
        const elem = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        tDrag.style.display = 'inline-block';
        const zone = elem ? elem.closest('.dropzone') : null;
        if(zone) zone.appendChild(tDrag);
        
        document.removeEventListener('touchmove', touchMove);
        document.removeEventListener('touchend', touchEnd);
        tDrag = null;
    }
    
    // Dropzones
    document.querySelectorAll('.dropzone').forEach(z => {
        z.addEventListener('dragover', e => e.preventDefault());
        z.addEventListener('drop', e => {
            e.preventDefault();
            const d = document.querySelector('.dragging');
            if(d) z.appendChild(d);
        });
    });
    
    window.checkDrag = () => {
        let c=0;
        document.querySelectorAll('.dropzone').forEach(z => {
            z.querySelectorAll('.draggable').forEach(d => {
                if(z.id.includes(d.dataset.type)) { d.style.background='#d4edda'; c++; }
                else d.style.background='#f8d7da';
            });
        });
        document.getElementById('drag-feedback').textContent = `Correct: ${c}`;
    }
    document.getElementById('check-drag-btn').onclick = checkDrag;

    // Flashcards
    let cIdx = 0;
    function loadCard() {
        const d = flashcardData[cIdx];
        const clean = d.es.replace(/<[^>]*>?/gm, '');
        document.getElementById('card-front').innerHTML = d.en;
        document.getElementById('card-back').innerHTML = `${d.es} <span class="tts-icon" data-tts="${clean}">üîä</span><br><small>${d.explanation}</small>`;
        document.getElementById('flashcard').classList.remove('is-flipped');
    }
    window.flipCard = () => document.getElementById('flashcard').classList.toggle('is-flipped');
    window.nextCard = () => { cIdx=(cIdx+1)%flashcardData.length; loadCard(); };
    window.prevCard = () => { cIdx=(cIdx-1+flashcardData.length)%flashcardData.length; loadCard(); };
    document.getElementById('flashcard').onclick = (e) => { if(!e.target.classList.contains('tts-icon')) flipCard(); };

    // Lang Toggle
    window.toggleLang = () => {
        currentLang = currentLang === 'en' ? 'es' : 'en';
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const k = el.dataset.langKey;
            if(uiData[currentLang][k]) el.innerHTML = uiData[currentLang][k];
        });
    }

    loadCard();
});
</script>
</body>
</html>
