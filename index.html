<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si Clauses + Commands</title>
    
    <style>
        :root {
            /* Paleta Azul Est√°ndar */
            --primary-blue: #007bff;
            --dark-blue: #0056b3;
            --green: #28a745;
            --red: #dc3545;
            --yellow: #f0ad4e;
            
            --bg-color: #f0f4f8;
            --container-bg: #ffffff;
            --text-color: #333;
            --header-bg: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            --tab-bg: #f1f1f1;
            --tab-active-bg: var(--primary-blue);
            --tab-text: #555;
            --tab-active-text: #ffffff;
            --border-color: #dee2e6;
            --light-gray-bg: #f8f9fa;
        }

        /* Modo Oscuro */
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #1e1e1e;
            --tab-bg: #333;
            --tab-active-bg: var(--primary-blue);
            --tab-text: #bbb;
            --tab-active-text: #ffffff;
            --border-color: #444;
            --light-gray-bg: #2a2a20;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 950px;
            margin: 0 auto;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.07);
            overflow: hidden;
            transition: background-color 0.3s;
        }
        header {
            background: var(--header-bg);
            color: white;
            padding: 20px 35px;
            text-align: center;
            position: relative;
        }
        header h1 { margin: 0; font-size: 2.5em; }
        header p { font-size: 1.2em; opacity: 0.9; margin: 5px 0 0; }
        
        .header-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }
        .control-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
        }
        .control-button:hover { background: rgba(255,255,255,0.4); }

        /* Pesta√±as */
        .main-tab-nav {
            display: flex;
            background-color: var(--tab-bg);
            border-bottom: 3px solid var(--dark-blue);
        }
        .main-tab-nav button {
            background-color: inherit; border: none; outline: none; cursor: pointer;
            padding: 18px 25px; transition: 0.3s; font-size: 1.1em;
            font-weight: bold; color: var(--tab-text); flex-grow: 1;
        }
        .main-tab-nav button:hover { background-color: var(--border-color); }
        .main-tab-nav button.active { background-color: var(--tab-active-bg); color: var(--tab-active-text); }
        
        .main-tab-content { display: none; padding: 30px; }
        .main-tab-content.is-active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Estilos Generales */
        h2 { color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); padding-bottom: 5px; font-size: 1.8em; margin-top: 0; }
        h3 { color: var(--green); font-size: 1.4em; margin-top: 25px; }
        .accent { color: var(--primary-blue); font-weight: bold; }
        
        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .tense-box { background-color: var(--light-gray-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; }
        
        .icon-wrapper { font-size: 4em; margin-bottom: 10px; display:block; }
        
        /* Video */
        .video-placeholder {
            background: var(--light-gray-bg); border: 2px dashed var(--border-color);
            border-radius: 8px; padding: 20px; text-align: center; margin-top: 20px;
        }
        .video-container {
            position: relative; width: 100%; padding-bottom: 56.25%; height: 0;
            overflow: hidden; border-radius: 8px; background: #000; margin-top: 20px; border: 1px solid var(--border-color);
        }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        /* Visualizador */
        .formula-visualizer {
            background-color: var(--light-gray-bg); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 20px; text-align: center; margin-top: 20px;
        }
        .formula-row { display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;}
        .formula-card {
            padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1.2em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer;
        }
        .fc-condition { background: #e8f5e9; color: #2e7d32; border: 2px solid #2e7d32; }
        .fc-arrow { font-size: 1.5em; color: #555; }
        .fc-command { background: #e3f2fd; color: #1565c0; border: 2px solid #1565c0; }

        /* Tablas */
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; }
        th { background-color: var(--light-gray-bg); }

        /* Pr√°ctica */
        .quiz-section { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed var(--border-color); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .refresh-btn { font-size: 0.9em; padding: 5px 10px; background-color: var(--primary-blue); color: white; border:none; border-radius: 4px; cursor: pointer;}

        .quiz-question { margin-bottom: 15px; background: var(--light-gray-bg); padding: 15px; border-radius: 5px; }
        .quiz-question button { background-color: var(--container-bg); border: 1px solid var(--primary-blue); color: var(--primary-blue); padding: 8px 15px; margin-right: 10px; border-radius: 5px; cursor: pointer; margin-top: 5px; }
        .quiz-question button:hover { background-color: var(--primary-blue); color: white; }
        
        .feedback { font-weight: bold; margin-left: 10px; }
        .correct { color: var(--green); } .incorrect { color: var(--red); }
        .explanation-text { font-size: 0.9em; color: #555; margin-top: 10px; padding: 8px; background: #e9ecef; border-radius: 4px; }
        .explanatory-note { font-size: 0.9em; font-style: italic; background: var(--light-gray-bg); padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px dashed var(--border-color);}

        /* Historia */
        .interactive-story { background: #fffbe6; border: 1px solid #ffe58f; padding: 20px; border-radius: 8px; font-size: 1.1em; line-height: 2; }
        .interactive-story select { padding: 2px 5px; border: 1px solid #ccc; border-radius: 4px; }
        body.dark-mode .interactive-story { background: #2c2c20; border-color: #444; color: #eee; }

        /* Drag Drop */
        .sorter-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .dropzone { min-height: 200px; background: var(--light-gray-bg); border: 3px dashed var(--border-color); border-radius: 8px; padding: 10px; }
        .dropzone h4 { text-align: center; margin-top: 0; color: var(--dark-blue); }
        .draggable { background-color: var(--container-bg); border: 1px solid #ccc; padding: 10px; margin-bottom: 8px; border-radius: 5px; cursor: grab; display: inline-block; margin-right: 5px; }
        .draggable.dragging { opacity: 0.5; border: 2px dashed var(--primary-blue); }
        #items-to-sort { margin-top: 20px; padding: 10px; background: var(--tab-bg); border-radius: 8px; min-height: 60px; }

        /* --- FLASHCARDS (CSS CORREGIDO) --- */
        .flashcard-app { display: flex; flex-direction: column; align-items: center; }
        .flashcard-container { width: 90%; max-width: 500px; height: 300px; perspective: 1000px; margin-bottom: 20px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 10px; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        
        .card-face { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            backface-visibility: hidden; 
            
            /* FLEXBOX CENTRADO EST√ÅNDAR */
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            text-align: center; 
            
            padding: 25px; 
            border-radius: 10px; 
            box-sizing: border-box; 
            
            /* TEXTO NORMAL */
            font-size: 1.4em;
            line-height: 1.4;
            white-space: normal; /* Asegura que el texto baje de l√≠nea */
            overflow: hidden;
        }
        
        .card-front { background: var(--container-bg); border: 2px solid var(--primary-blue); color: var(--text-color); }
        .card-back { background: var(--light-gray-bg); border: 2px solid var(--green); color: var(--dark-blue); transform: rotateY(180deg); }
        .card-back p { margin: 15px 0 0; font-size: 0.8em; color: var(--text-color); opacity: 0.8; }
        body.dark-mode .card-back { color: var(--text-color); }
        
        .flashcard-nav { display: flex; justify-content: center; gap: 20px; }
        .flashcard-nav button { font-size: 1em; font-weight: bold; }

        .tts-icon { font-size: 1.1em; cursor: pointer; margin-left: 8px; transition: transform 0.2s; }
        .tts-icon:hover { transform: scale(1.2); }

    </style>
</head>
<body class="">

    <div class="container">
        <header>
            <div class="header-controls">
                <button class="control-button" onclick="toggleLang()">EN / ES</button>
                <button class="control-button" onclick="toggleTheme()">‚òÄÔ∏è/üåô</button>
            </div>
            <h1 data-lang-key="header_title">Si Clauses + Commands</h1>
            <p data-lang-key="header_subtitle">Giving Advice & Instructions</p>
        </header>
        
        <nav class="main-tab-nav">
            <button class="main-tab-link active" onclick="changeMainTab(event, 'tab-metaphor')" data-lang-key="tab_1">üö¶ The Concept</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-formacion')" data-lang-key="tab_2">‚úçÔ∏è The Formula</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-practica')" data-lang-key="tab_3">üß† Interactive Practice</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-flashcards')" data-lang-key="tab_4">üìá Flashcards</button>
        </nav>

        <main>
            <div id="tab-metaphor" class="main-tab-content is-active">
                <h2 data-lang-key="metaphor_title">Condition & Reaction</h2>
                
                <div class="comparison-grid">
                    <div class="tense-box">
                        <span class="icon-wrapper">ü§î</span>
                        <h3 style="color: var(--green);" data-lang-key="cond_title">The Condition (Si...)</h3>
                        <p data-lang-key="metaphor_cond">If a specific situation happens...</p>
                        <p><em>"Si <strong>tienes</strong> fr√≠o..."</em></p>
                    </div>
                    <div class="tense-box">
                        <span class="icon-wrapper">üëâ</span>
                        <h3 style="color: var(--primary-blue);" data-lang-key="cmd_title">The Command (¬°Hazlo!)</h3>
                        <p data-lang-key="metaphor_cmd">...do this action immediately.</p>
                        <p><em>"¬°<strong>Ponte</strong> un abrigo!"</em></p>
                    </div>
                </div>

                <h3 style="margin-top: 30px;" data-lang-key="video_title">Video Tutorial</h3>
                <div class="video-container">
                    <iframe src="https://drive.google.com/file/d/1voQ1bwByvhucuyRyR5sUbfHmFhZO5XZ0/preview" allow="autoplay"></iframe>
                </div>

                <h3 style="margin-top: 30px;" data-lang-key="viz_title">Interactive Formula</h3>
                <div class="formula-visualizer">
                    <p data-lang-key="viz_desc">Click the condition to see the command.</p>
                    <div class="formula-row">
                        <div class="formula-card fc-condition" onclick="toggleViz()">Si (t√∫) <strong>vas</strong> a la fiesta...</div>
                        <div class="fc-arrow">‚û°Ô∏è</div>
                        <div class="formula-card fc-command" id="viz-result">???</div>
                    </div>
                </div>
            </div>

            <div id="tab-formacion" class="main-tab-content">
                <h2 data-lang-key="form_title">The Structure</h2>
                
                <div class="comparison-grid">
                    <div class="tense-box" style="border-top: 4px solid var(--green);">
                        <h3>1. The Clause (Si + Present)</h3>
                        <p>Use the <strong>Present Indicative</strong>.</p>
                        <ul style="text-align:left;">
                            <li>Si <strong>tienes</strong> tiempo...</li>
                            <li>Si <strong>vas</strong> al cine...</li>
                            <li>Si <strong>est√°s</strong> enfermo...</li>
                        </ul>
                    </div>
                    <div class="tense-box" style="border-top: 4px solid var(--primary-blue);">
                        <h3>2. The Command (Imperative)</h3>
                        <p>Use the <strong>Imperative (Mandato)</strong>.</p>
                        <ul style="text-align:left;">
                            <li>...<strong>ll√°mame</strong>.</li>
                            <li>...<strong>compra</strong> palomitas.</li>
                            <li>...<strong>ve</strong> al m√©dico.</li>
                        </ul>
                    </div>
                </div>

                <h3>Key Irregular Commands (T√∫)</h3>
                <p>Memorize these short forms:</p>
                <table>
                    <tr><th>Infinitive</th><th>Command (T√∫)</th></tr>
                    <tr><td>Venir</td><td><strong>Ven</strong></td></tr>
                    <tr><td>Decir</td><td><strong>Di</strong></td></tr>
                    <tr><td>Salir</td><td><strong>Sal</strong></td></tr>
                    <tr><td>Hacer</td><td><strong>Haz</strong></td></tr>
                    <tr><td>Tener</td><td><strong>Ten</strong></td></tr>
                    <tr><td>Ir</td><td><strong>Ve</strong></td></tr>
                    <tr><td>Poner</td><td><strong>Pon</strong></td></tr>
                    <tr><td>Ser</td><td><strong>S√©</strong></td></tr>
                </table>
            </div>

            <div id="tab-practica" class="main-tab-content">
                <h2 data-lang-key="practice_main_title">Interactive Practice</h2>
                
                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="quiz_title">Part 1: Quick Quiz</h3>
                        <button id="generate-quiz" class="refresh-btn button-secondary" data-lang-key="btn_new">New Quiz</button>
                    </div>
                    <div class="explanatory-note" data-lang-key="quiz_note">Note: Audio reads infinitives to avoid spoilers.</div>
                    <div id="quiz-container"></div>
                </div>

                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="story_title">Part 2: Advice Story</h3>
                        <button id="generate-story" class="refresh-btn button-secondary" data-lang-key="btn_new_story">New Story</button>
                    </div>
                    <div id="story-container" class="interactive-story"></div>
                    <button id="check-story-btn" class="button-primary" style="margin-top: 20px;" data-lang-key="btn_check">Check Story</button>
                </div>

                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="drag_title">Part 3: Logic Matcher</h3>
                        <button id="generate-drag" class="refresh-btn button-secondary" data-lang-key="btn_new_match">New Matcher</button>
                    </div>
                    <p data-lang-key="drag_desc">Match the <strong>Condition</strong> (Green) with the logical <strong>Command</strong> (Blue).</p>
                    
                    <div id="items-to-sort">
                        <div id="drag-items-pool"></div>
                    </div>
                    
                    <div class="sorter-container">
                        <div class="dropzone" id="zone-condition">
                            <h4 style="color: var(--green);">If... (Condition)</h4>
                        </div>
                        <div class="dropzone" id="zone-command">
                            <h4 style="color: var(--primary-blue);">Then... (Command)</h4>
                        </div>
                    </div>
                    <button id="check-drag-btn" class="button-primary" style="margin-top: 20px;" data-lang-key="btn_check_match">Check Matches</button>
                    <div id="drag-feedback" class="feedback"></div>
                </div>
            </div>

            <div id="tab-flashcards" class="main-tab-content">
                <h2>Flashcards</h2>
                <div class="flashcard-app">
                    <div class="flashcard-container">
                        <div class="flashcard" id="flashcard">
                            <div class="card-face card-front" id="card-front"></div>
                            <div class="card-face card-back" id="card-back"></div>
                        </div>
                    </div>
                    <div class="flashcard-nav">
                        <button onclick="prevCard()" class="button-secondary" data-lang-key="btn_prev">Previous</button>
                        <button onclick="flipCard()" class="button-primary" data-lang-key="btn_flip">Flip</button>
                        <button onclick="nextCard()" class="button-secondary" data-lang-key="btn_next">Next</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

<script>

// --- DATA & TRANSLATIONS ---
const uiData = {
    en: {
        header_title: "Si Clauses + Commands",
        header_subtitle: "Giving Advice & Instructions",
        tab_1: "üö¶ The Concept",
        tab_2: "‚úçÔ∏è The Formula",
        tab_3: "üß† Interactive Practice",
        tab_4: "üìá Flashcards",
        metaphor_title: "Condition & Reaction",
        cond_title: "The Condition (Si...)",
        metaphor_cond: "If a specific situation happens...",
        cmd_title: "The Command (Do it!)",
        metaphor_cmd: "...do this action immediately.",
        video_title: "Video Tutorial",
        viz_title: "Interactive Formula",
        viz_desc: "Click the condition to see the command.",
        form_title: "The Structure",
        practice_main_title: "Interactive Practice",
        quiz_title: "Part 1: Quick Quiz",
        btn_new: "New Quiz",
        quiz_note: "Note: Audio reads infinitives to avoid spoilers.",
        story_title: "Part 2: Advice Story",
        btn_new_story: "New Story",
        btn_check: "Check Story",
        drag_title: "Part 3: Logic Matcher",
        btn_new_match: "New Matcher",
        drag_desc: "Match the Condition (Green) with the logical Command (Blue).",
        btn_check_match: "Check Matches",
        btn_prev: "Previous",
        btn_flip: "Flip",
        btn_next: "Next"
    },
    es: {
        header_title: "Si + Mandatos",
        header_subtitle: "Dar Consejos e Instrucciones",
        tab_1: "üö¶ El Concepto",
        tab_2: "‚úçÔ∏è La F√≥rmula",
        tab_3: "üß† Pr√°ctica Interactiva",
        tab_4: "üìá Flashcards",
        metaphor_title: "Condici√≥n y Reacci√≥n",
        cond_title: "La Condici√≥n (Si...)",
        metaphor_cond: "Si ocurre una situaci√≥n...",
        cmd_title: "El Mandato (¬°Hazlo!)",
        metaphor_cmd: "...haz esta acci√≥n inmediatamente.",
        video_title: "Video Tutorial",
        viz_title: "F√≥rmula Interactiva",
        viz_desc: "Haz clic en la condici√≥n para ver el mandato.",
        form_title: "La Estructura",
        practice_main_title: "Pr√°ctica Interactiva",
        quiz_title: "Parte 1: Quiz R√°pido",
        btn_new: "Nuevo Quiz",
        quiz_note: "Nota: El audio lee infinitivos para no revelar la respuesta.",
        story_title: "Parte 2: Historia de Consejos",
        btn_new_story: "Nueva Historia",
        btn_check: "Verificar Historia",
        drag_title: "Parte 3: Parejas L√≥gicas",
        btn_new_match: "Nuevo Juego",
        drag_desc: "Une la Condici√≥n (Verde) con el Mandato l√≥gico (Azul).",
        btn_check_match: "Verificar Parejas",
        btn_prev: "Anterior",
        btn_flip: "Voltear",
        btn_next: "Siguiente"
    }
};

let currentLang = 'en';

// 20 Flashcards
const flashcardData = [
    { en: "If you have time, call me.", es: "Si <strong>tienes</strong> tiempo, <strong>ll√°mame</strong>.", explanation: "Si + Present -> Command" },
    { en: "If you go to the store, buy milk.", es: "Si <strong>vas</strong> a la tienda, <strong>compra</strong> leche.", explanation: "Ir (vas) -> Comprar (compra)" },
    { en: "If you are tired, sleep.", es: "Si <strong>est√°s</strong> cansado, <strong>duerme</strong>.", explanation: "Estar (est√°s) -> Dormir (duerme)" },
    { en: "If you see Juan, tell him hi.", es: "Si <strong>ves</strong> a Juan, <strong>dile</strong> hola.", explanation: "Ver (ves) -> Decir (di - irregular)" },
    { en: "If you want to pass, study.", es: "Si <strong>quieres</strong> aprobar, <strong>estudia</strong>.", explanation: "Querer (quieres) -> Estudiar (estudia)" },
    { en: "If it rains, take an umbrella.", es: "Si <strong>llueve</strong>, <strong>lleva</strong> un paraguas.", explanation: "Llover (llueve) -> Llevar (lleva)" },
    { en: "If you are cold, put on a coat.", es: "Si <strong>tienes</strong> fr√≠o, <strong>ponte</strong> un abrigo.", explanation: "Tener (tienes) -> Ponerse (ponte - irregular)" },
    { en: "If you leave, close the door.", es: "Si <strong>sales</strong>, <strong>cierra</strong> la puerta.", explanation: "Salir (sales) -> Cerrar (cierra)" },
    { en: "If you are hungry, eat something.", es: "Si <strong>tienes</strong> hambre, <strong>come</strong> algo.", explanation: "Tener (tienes) -> Comer (come)" },
    { en: "If you don't understand, ask.", es: "Si no <strong>entiendes</strong>, <strong>pregunta</strong>.", explanation: "Entender (entiendes) -> Preguntar (pregunta)" },
    { en: "If you have a problem, tell me.", es: "Si <strong>tienes</strong> un problema, <strong>d√≠melo</strong>.", explanation: "Decir (di) + me + lo" },
    { en: "If you come early, help me.", es: "Si <strong>vienes</strong> temprano, <strong>ay√∫dame</strong>.", explanation: "Venir (vienes) -> Ayudar (ayuda)" },
    { en: "If you are sad, listen to music.", es: "Si <strong>est√°s</strong> triste, <strong>escucha</strong> m√∫sica.", explanation: "Estar (est√°s) -> Escuchar (escucha)" },
    { en: "If you make a mistake, fix it.", es: "Si <strong>haces</strong> un error, <strong>arr√©glalo</strong>.", explanation: "Hacer (haces) -> Arreglar (arregla)" },
    { en: "If you go out, be careful.", es: "Si <strong>sales</strong>, <strong>ten</strong> cuidado.", explanation: "Tener (ten - irregular)" },
    { en: "If you drive, don't drink.", es: "Si <strong>conduces</strong>, no <strong>bebas</strong>.", explanation: "Negative Command (Subjunctive form)" },
    { en: "If you visit Paris, go to the Louvre.", es: "Si <strong>visitas</strong> Par√≠s, <strong>ve</strong> al Louvre.", explanation: "Ir (ve - irregular)" },
    { en: "If you cook, clean the kitchen.", es: "Si <strong>cocinas</strong>, <strong>limpia</strong> la cocina.", explanation: "Cocinar -> Limpiar" },
    { en: "If you are bored, read a book.", es: "Si <strong>est√°s</strong> aburrido, <strong>lee</strong> un libro.", explanation: "Estar -> Leer" },
    { en: "If you love her, tell her.", es: "Si la <strong>amas</strong>, <strong>d√≠selo</strong>.", explanation: "Decir (di) + se + lo" }
];

// 25 Quiz Questions
const quizBank = [
    { q: "Si (tener) tiempo, (llamar) a Mar√≠a.", options: ["tienes / llama", "tengas / llames"], correct: 0, explanation: "Si + Present Ind. -> Command." },
    { q: "Si (ir) al mercado, (comprar) pan.", options: ["vas / compra", "vayas / compres"], correct: 0, explanation: "Ir (vas) -> Comprar (compra)." },
    { q: "Si (ver) a Luis, (decir) la verdad.", options: ["veas / di", "ves / dile"], correct: 1, explanation: "Ver (ves) -> Decir (di + le)." },
    { q: "Si no (entender), (preguntar).", options: ["entiendes / pregunta", "entiendas / preguntes"], correct: 0, explanation: "Entender (e-ie) -> Preguntar." },
    { q: "Si (estar) cansado, (descansar).", options: ["est√°s / descansa", "est√©s / descansas"], correct: 0, explanation: "Estar (est√°s) -> Descansar." },
    { q: "Si (hacer) sol, (ponerse) crema.", options: ["hace / ponte", "haga / ponga"], correct: 0, explanation: "Hacer (hace) -> Ponerse (pon + te)." },
    { q: "Si (querer) venir, (venir).", options: ["quieres / ven", "quieras / vengas"], correct: 0, explanation: "Querer (quieres) -> Venir (ven - irreg)." },
    { q: "Si (salir), (cerrar) la puerta.", options: ["sales / cierra", "salgas / cierres"], correct: 0, explanation: "Salir (sales) -> Cerrar (cierra)." },
    { q: "Si (tener) hambre, (comer).", options: ["tienes / come", "tengas / comas"], correct: 0, explanation: "Tener -> Comer." },
    { q: "Si (ser) valiente, (hacerlo).", options: ["eres / hazlo", "seas / hazlo"], correct: 0, explanation: "Ser (eres) -> Hacer (haz + lo)." },
    { q: "Si te (doler) la cabeza, (tomar) esto.", options: ["duele / toma", "duela / tomes"], correct: 0, explanation: "Doler (duele) -> Tomar." },
    { q: "Si (buscar) paz, (meditar).", options: ["buscas / medita", "busques / medites"], correct: 0, explanation: "Buscar -> Meditar." },
    { q: "Si (necesitar) ayuda, (pedir).", options: ["necesitas / pide", "necesites / pidas"], correct: 0, explanation: "Pedir (pide)." },
    { q: "Si (sentirse) mal, (ir) al m√©dico.", options: ["te sientes / ve", "te sientas / vaya"], correct: 0, explanation: "Ir (ve - irreg)." },
    { q: "Si (romper) algo, (pagar).", options: ["rompes / paga", "rompas / pagues"], correct: 0, explanation: "Romper -> Pagar." },
    { q: "Si (escuchar) m√∫sica, (bailar).", options: ["escuchas / baila", "escuches / bailes"], correct: 0, explanation: "Escuchar -> Bailar." },
    { q: "Si (llegar) tarde, no (entrar).", options: ["llegas / entres", "llegues / entra"], correct: 0, explanation: "Negative command uses subjunctive form (no entres)." },
    { q: "Si (poder), (ayudarme).", options: ["puedes / ay√∫dame", "puedas / ayuda"], correct: 0, explanation: "Poder -> Ayudar." },
    { q: "Si (leer) esto, (compartir).", options: ["lees / comparte", "leas / compartas"], correct: 0, explanation: "Leer -> Compartir." },
    { id: "q20", q: "Si (viajar), (disfrutar).", options: ["viajas / disfruta", "viajes / disfrutes"], correct: 0, explanation: "Viajar -> Disfrutar." },
    { id: "q21", q: "Si (perder), no (llorar).", options: ["pierdes / llores", "pierdas / llora"], correct: 0, explanation: "Negative Command (no llores)." },
    { id: "q22", q: "Si (beber), no (conducir).", options: ["bebes / conduzcas", "bebas / conduces"], correct: 0, explanation: "Neg command (no conduzcas)." },
    { id: "q23", q: "Si (ver) el error, (corregir).", options: ["ves / corrige", "veas / corrigas"], correct: 0, explanation: "Ver -> Corregir." },
    { id: "q24", q: "Si (hacer) fr√≠o, (abrigarse).", options: ["hace / abr√≠gate", "haga / abrigarte"], correct: 0, explanation: "Hacer -> Abrigarse (reflexive)." },
    { id: "q25", q: "Si (querer) paz, (perdonar).", options: ["quieres / perdona", "quieras / perdonas"], correct: 0, explanation: "Querer -> Perdonar." }
];

// 5 Stories
const storyBank = [
    {
        id: "story1",
        html: `
            <h3>Consejos de Salud üè•</h3>
            <span>Si t√∫</span> 
            <select id="s1-1" data-ans="quieres"><option value="w">quieras</option><option value="c">quieres</option></select>
            <span>estar sano,</span> 
            <select id="s1-2" data-ans="come"><option value="c">come</option><option value="w">comas</option></select>
            <span>bien. Si te</span> 
            <select id="s1-3" data-ans="sientes"><option value="c">sientes</option><option value="w">sientas</option></select>
            <span>cansado,</span> 
            <select id="s1-4" data-ans="duerme"><option value="w">duermas</option><option value="c">duerme</option></select>
            <span>ocho horas. Si no</span> 
            <select id="s1-5" data-ans="tienes"><option value="c">tienes</option><option value="w">tengas</option></select>
            <span>tiempo,</span> 
            <select id="s1-6" data-ans="haz"><option value="c">haz</option><option value="w">hagas</option></select>
            <span>ejercicio en casa.</span>
        `
    },
    {
        id: "story2",
        html: `
            <h3>Preparando un Viaje ‚úàÔ∏è</h3>
            <span>Si</span> 
            <select id="s2-1" data-ans="vas"><option value="c">vas</option><option value="w">vayas</option></select>
            <span>a Espa√±a,</span> 
            <select id="s2-2" data-ans="visita"><option value="w">visites</option><option value="c">visita</option></select>
            <span>Madrid. Si</span> 
            <select id="s2-3" data-ans="necesitas"><option value="c">necesitas</option><option value="w">necesites</option></select>
            <span>ayuda,</span> 
            <select id="s2-4" data-ans="pregunta"><option value="c">pregunta</option><option value="w">preguntes</option></select>
            <span>a la gente. Si</span> 
            <select id="s2-5" data-ans="tienes"><option value="c">tienes</option><option value="w">tengas</option></select>
            <span>hambre,</span> 
            <select id="s2-6" data-ans="prueba"><option value="c">prueba</option><option value="w">pruebes</option></select>
            <span>las tapas.</span>
        `
    },
    {
        id: "story3",
        html: `
            <h3>En la Cocina üç≥</h3>
            <span>Si</span> 
            <select id="s3-1" data-ans="cocinas"><option value="c">cocinas</option><option value="w">cocines</option></select>
            <span>pasta,</span> 
            <select id="s3-2" data-ans="hierve"><option value="w">hirvas</option><option value="c">hierve</option></select>
            <span>el agua primero. Si</span> 
            <select id="s3-3" data-ans="usas"><option value="c">usas</option><option value="w">uses</option></select>
            <span>cuchillos,</span> 
            <select id="s3-4" data-ans="ten"><option value="c">ten</option><option value="w">tengas</option></select>
            <span>cuidado. Si</span> 
            <select id="s3-5" data-ans="terminas"><option value="c">terminas</option><option value="w">termines</option></select>
            <span>de comer,</span> 
            <select id="s3-6" data-ans="lava"><option value="c">lava</option><option value="w">laves</option></select>
            <span>los platos.</span>
        `
    },
    {
        id: "story4",
        html: `
            <h3>En la Escuela üìö</h3>
            <span>Si no</span> 
            <select id="s4-1" data-ans="comprendes"><option value="c">comprendes</option><option value="w">comprendas</option></select>
            <span>la lecci√≥n,</span> 
            <select id="s4-2" data-ans="levanta"><option value="w">levantes</option><option value="c">levanta</option></select>
            <span>la mano. Si</span> 
            <select id="s4-3" data-ans="quieres"><option value="c">quieres</option><option value="w">quieras</option></select>
            <span>sacar buenas notas,</span> 
            <select id="s4-4" data-ans="estudia"><option value="c">estudia</option><option value="w">estudies</option></select>
            <span>todos los d√≠as. Si</span> 
            <select id="s4-5" data-ans="sales"><option value="c">sales</option><option value="w">salgas</option></select>
            <span>tarde,</span> 
            <select id="s4-6" data-ans="corre"><option value="c">corre</option><option value="w">corras</option></select>
            <span>al autob√∫s.</span>
        `
    },
    {
        id: "story5",
        html: `
            <h3>Seguridad Online üîí</h3>
            <span>Si</span> 
            <select id="s5-1" data-ans="usas"><option value="c">usas</option><option value="w">uses</option></select>
            <span>internet,</span> 
            <select id="s5-2" data-ans="protege"><option value="w">protejas</option><option value="c">protege</option></select>
            <span>tu contrase√±a. Si</span> 
            <select id="s5-3" data-ans="ves"><option value="c">ves</option><option value="w">veas</option></select>
            <span>algo raro, no</span> 
            <select id="s5-4" data-ans="hagas"><option value="c">hagas</option><option value="w">haz</option></select>
            <span>clic. Si</span> 
            <select id="s5-5" data-ans="recibes"><option value="c">recibes</option><option value="w">recibas</option></select>
            <span>spam,</span> 
            <select id="s5-6" data-ans="b√≥rralo"><option value="c">b√≥rralo</option><option value="w">b√≥rrelo</option></select>
            <span>inmediatamente.</span>
        `
    }
];

// 20 Drag Items (Logic: If... -> Then...)
const dragDropBank = [
    { text: "Si tienes fr√≠o...", type: "condition" }, { text: "¬°Ponte un abrigo!", type: "command" },
    { text: "Si est√°s cansado...", type: "condition" }, { text: "¬°Duerme un poco!", type: "command" },
    { text: "Si tienes hambre...", type: "condition" }, { text: "¬°Come una manzana!", type: "command" },
    { text: "Si te duele la cabeza...", type: "condition" }, { text: "¬°Toma una aspirina!", type: "command" },
    { text: "Si no entiendes...", type: "condition" }, { text: "¬°Pregunta al profesor!", type: "command" },
    { text: "Si vas a la playa...", type: "condition" }, { text: "¬°Usa protector solar!", type: "command" },
    { text: "Si quieres aprobar...", type: "condition" }, { text: "¬°Estudia m√°s!", type: "command" },
    { text: "Si ves un accidente...", type: "condition" }, { text: "¬°Llama a la polic√≠a!", type: "command" },
    { text: "Si llegas tarde...", type: "condition" }, { text: "¬°Corre!", type: "command" },
    { text: "Si est√°s aburrido...", type: "condition" }, { text: "¬°Lee un libro!", type: "command" },
    { text: "Si llueve...", type: "condition" }, { text: "¬°Lleva paraguas!", type: "command" },
    { text: "Si cocinas...", type: "condition" }, { text: "¬°Lava los platos!", type: "command" }
];

// --- LOGIC ---

document.addEventListener('DOMContentLoaded', () => {
    let currentStoryData = {};

    // 1. TABS
    window.changeMainTab = function(evt, tabId) {
        document.querySelectorAll('.main-tab-content').forEach(el => el.classList.remove('is-active'));
        document.querySelectorAll('.main-tab-link').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('is-active');
        evt.currentTarget.classList.add('active');
        
        if (tabId === 'tab-practica' && !document.getElementById('quiz-container').hasChildNodes()) {
            generateQuiz(); generateStory(); generateDragDrop();
        }
    }

    // 2. VISUALIZER
    window.toggleViz = function() {
        const res = document.getElementById('viz-result');
        res.textContent = "¬°¬°Ponte un abrigo!!";
        res.style.backgroundColor = "#fff9c4";
        speak("Ponte un abrigo");
        setTimeout(() => res.style.backgroundColor = "#e3f2fd", 500);
    }

    // 3. QUIZ
    document.getElementById('generate-quiz').addEventListener('click', generateQuiz);

    function generateQuiz() {
        const container = document.getElementById('quiz-container');
        container.innerHTML = '';
        const selectedQuestions = [...quizBank].sort(() => 0.5 - Math.random()).slice(0, 5);
        
        selectedQuestions.forEach((q, i) => {
            const qId = `q_${i}`;
            // Clean audio text
            const cleanQ = q.q.replace(/[()]/g, "");
            const tts = `<span class="tts-icon" data-tts="${cleanQ}">üîä</span>`;
            
            let html = `<div class="quiz-question" id="${qId}">
                <p>${i+1}. ${q.q} ${tts}</p>`;
            
            q.options.forEach((opt, idx) => {
                html += `<button onclick="checkQuiz('${qId}', ${idx === q.correct})">${opt}</button>`;
            });
            
            html += `<span class="feedback"></span>
                     <div class="explanation-text" style="display:none;">${q.explanation}</div>
                     </div>`;
            container.innerHTML += html;
        });
    }

    window.checkQuiz = function(qId, isCorrect) {
        const el = document.getElementById(qId);
        const fb = el.querySelector('.feedback');
        const exp = el.querySelector('.explanation-text');
        exp.style.display = 'block';
        if(isCorrect) {
            fb.textContent = "Correct! üëç"; fb.className = "feedback correct";
        } else {
            fb.textContent = "Try again. üòï"; fb.className = "feedback incorrect";
        }
    }

    // 4. STORY
    document.getElementById('generate-story').addEventListener('click', generateStory);
    document.getElementById('check-story-btn').addEventListener('click', checkStory);

    function generateStory() {
        currentStoryData = storyBank[Math.floor(Math.random() * storyBank.length)];
        document.getElementById('story-container').innerHTML = currentStoryData.html;
        document.querySelectorAll('.story-explanation').forEach(e=>e.remove());
    }

    function checkStory() {
        const container = document.getElementById('story-container');
        
        const selects = container.querySelectorAll('select');
        selects.forEach(sel => {
            const val = sel.value;
            const isCorrect = val === 'c';
            
            sel.style.borderColor = isCorrect ? "var(--green)" : "var(--red)";
            sel.style.backgroundColor = isCorrect ? "#d4edda" : "#f8d7da";
        });
    }

    // 5. DRAG & DROP
    const dragPool = document.getElementById('drag-items-pool');
    document.getElementById('generate-drag').addEventListener('click', generateDragDrop);
    document.getElementById('check-drag-btn').addEventListener('click', checkDrag);
    
    let currentDragItems = [];

    function generateDragDrop() {
        dragPool.innerHTML = '';
        document.getElementById('drag-feedback').textContent = '';
        document.querySelectorAll('.dropzone .draggable').forEach(e => e.remove());
        document.querySelectorAll('.drag-explanation').forEach(e => e.remove());

        // Pick 8 random pairs (well, mixed)
        currentDragItems = [...dragDropBank].sort(() => 0.5 - Math.random()).slice(0, 8);
        
        currentDragItems.forEach(item => {
            const el = document.createElement('div');
            el.className = 'draggable';
            el.draggable = true;
            const ttsHtml = `&nbsp;<span class="tts-icon" data-tts="${item.text.replace(/<[^>]*>?/gm, '')}">üîä</span>`;
            el.innerHTML = `${item.text} ${ttsHtml}`;
            el.dataset.type = item.type;
            
            el.addEventListener('dragstart', e => e.target.classList.add('dragging'));
            el.addEventListener('dragend', e => e.target.classList.remove('dragging'));
            el.addEventListener('touchstart', touchStart, {passive: false});
            
            dragPool.appendChild(el);
        });
        
        setupDropzones();
    }

    function setupDropzones() {
        document.querySelectorAll('.dropzone').forEach(zone => {
            zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', e => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                const dragging = document.querySelector('.dragging');
                if(dragging) zone.appendChild(dragging);
            });
        });
    }

    // Touch Logic
    let tDrag = null;
    function touchStart(e) {
        if(e.target.classList.contains('tts-icon')) return;
        tDrag = e.target.closest('.draggable');
        if(!tDrag) return;
        setTimeout(() => tDrag.classList.add('dragging'), 100);
        document.addEventListener('touchmove', touchMove, {passive: false});
        document.addEventListener('touchend', touchEnd);
    }
    function touchMove(e) {
        if(!tDrag || !tDrag.classList.contains('dragging')) return;
        e.preventDefault();
        const t = e.touches[0];
        tDrag.style.position = 'fixed';
        tDrag.style.zIndex = 1000;
        tDrag.style.left = (t.clientX - tDrag.offsetWidth/2) + 'px';
        tDrag.style.top = (t.clientY - tDrag.offsetHeight/2) + 'px';
    }
    function touchEnd(e) {
        if(!tDrag) return;
        const t = e.changedTouches[0];
        tDrag.style.position = ''; tDrag.style.zIndex = ''; tDrag.style.left = ''; tDrag.style.top = '';
        tDrag.classList.remove('dragging');
        
        const elem = document.elementFromPoint(t.clientX, t.clientY);
        const zone = elem ? elem.closest('.dropzone') : null;
        if(zone) zone.appendChild(tDrag);
        
        document.removeEventListener('touchmove', touchMove);
        document.removeEventListener('touchend', touchEnd);
        tDrag = null;
    }

    function checkDrag() {
        let correct = 0;
        const zones = {
            'zone-condition': 'condition',
            'zone-command': 'command'
        };
        
        for (const [zoneId, type] of Object.entries(zones)) {
            const zone = document.getElementById(zoneId);
            zone.querySelectorAll('.draggable').forEach(item => {
                if(item.dataset.type === type) {
                    item.style.backgroundColor = '#d4edda'; correct++;
                } else {
                    item.style.backgroundColor = '#f8d7da';
                }
            });
        }
        document.getElementById('drag-feedback').textContent = `Correct: ${correct}`;
    }

    // 6. FLASHCARDS
    let cIdx = 0;
    function loadCard() {
        const d = flashcardData[cIdx];
        const tts = `&nbsp;<span class="tts-icon" data-tts="${d.es.replace(/<[^>]*>?/gm, '')}">üîä</span>`;
        document.getElementById('card-front').innerHTML = d.en;
        document.getElementById('card-back').innerHTML = `${d.es} ${tts}<br><br><small>${d.explanation}</small>`;
        document.getElementById('flashcard').classList.remove('is-flipped');
    }
    window.flipCard = () => document.getElementById('flashcard').classList.toggle('is-flipped');
    window.nextCard = () => { cIdx = (cIdx+1)%flashcardData.length; loadCard(); };
    window.prevCard = () => { cIdx = (cIdx-1+flashcardData.length)%flashcardData.length; loadCard(); };
    
    document.getElementById('flashcard').addEventListener('click', function(e) {
        if(e.target.classList.contains('tts-icon')) {
            e.stopPropagation();
            speak(e.target.dataset.tts);
        } else {
            flipCard();
        }
    });

    // UI Functions
    window.toggleLang = function() {
        currentLang = currentLang === 'en' ? 'es' : 'en';
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            if(uiData[currentLang][key]) el.innerHTML = uiData[currentLang][key];
        });
    }

    window.toggleTheme = () => document.body.classList.toggle('dark-mode');

    // AUDIO ENGINE
    function speak(txt) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'es-ES';
        const voices = window.speechSynthesis.getVoices();
        const v = voices.find(voice => voice.name.includes('Google') && voice.lang.includes('es')) || 
                  voices.find(voice => (voice.name.includes('Monica') || voice.name.includes('Paulina')) && voice.lang.includes('es')) ||
                  voices.find(voice => voice.lang.includes('es'));
        if(v) u.voice = v;
        window.speechSynthesis.speak(u);
    }
    
    // Global TTS listener
    document.body.addEventListener('click', function(e) {
        if(e.target.classList.contains('tts-icon') && !e.target.closest('#flashcard')) {
            speak(e.target.dataset.tts);
        }
    });

    // Init
    loadCard();
    window.speechSynthesis.onvoiceschanged = () => {}; 
});
</script>
</body>
</html>
